<!DOCTYPE html>
<html lang="sk">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Gimme</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Gimme">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#6366f1">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="format-detection" content="telephone=no">
  
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
  <link rel="manifest" href="favicon/site.webmanifest">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            accent: {
              50: 'rgb(var(--accent-50) / <alpha-value>)',
              100: 'rgb(var(--accent-100) / <alpha-value>)',
              200: 'rgb(var(--accent-200) / <alpha-value>)',
              300: 'rgb(var(--accent-300) / <alpha-value>)',
              400: 'rgb(var(--accent-400) / <alpha-value>)',
              500: 'rgb(var(--accent-500) / <alpha-value>)',
              600: 'rgb(var(--accent-600) / <alpha-value>)',
              700: 'rgb(var(--accent-700) / <alpha-value>)',
              800: 'rgb(var(--accent-800) / <alpha-value>)',
              900: 'rgb(var(--accent-900) / <alpha-value>)',
            }
          }
        }
      }
    }
  </script>

  <!-- Vue.js 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Nostr Tools (v1.17 for stability with CDN) -->
  <script type="module">
    import * as NostrTools from 'https://esm.sh/nostr-tools@1.17.0';
    window.NostrTools = NostrTools;
    window.dispatchEvent(new Event('nostr-ready'));
  </script>

  <script>
    // IndexedDB wrapper for application data
    const DB_NAME = 'PaymeQRDatabase';
    const DB_VERSION = 1;
    const STORE_NAME = 'appData';

    class IndexedDBStorage {
      constructor() {
        this.db = null;
      }

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.db = request.result;
            resolve(this.db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              db.createObjectStore(STORE_NAME);
            }
          };
        });
      }

      async getItem(key) {
        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([STORE_NAME], 'readonly');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.get(key);

          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      async setItem(key, value) {
        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.put(value, key);

          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }

      async removeItem(key) {
        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.delete(key);

          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }
    }

    window.dbStorage = new IndexedDBStorage();
  </script>

  <style>
    /* System Fonts */
    html {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* Hide Scrollbar */
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Animations */
    .ease-spring {
      transition-timing-function: cubic-bezier(0.34, 1.3, 0.64, 1);
    }

    .snap-center {
      scroll-snap-align: center;
    }

    .snap-x {
      scroll-snap-type: x mandatory;
    }

    /* Accent Color Variables - Default: Indigo */
    :root {
      --accent-50: 238 242 255;
      --accent-100: 224 231 255;
      --accent-200: 199 210 254;
      --accent-300: 165 180 252;
      --accent-400: 129 140 248;
      --accent-500: 99 102 241;
      --accent-600: 79 70 229;
      --accent-700: 67 56 202;
      --accent-800: 55 48 163;
      --accent-900: 49 46 129;
    }

    .accent-rose {
      --accent-50: 255 241 242;
      --accent-100: 255 228 230;
      --accent-200: 254 205 211;
      --accent-300: 253 164 175;
      --accent-400: 251 113 133;
      --accent-500: 244 63 94;
      --accent-600: 225 29 72;
      --accent-700: 190 18 60;
      --accent-800: 159 18 57;
      --accent-900: 136 19 55;
    }

    .accent-emerald {
      --accent-50: 236 253 245;
      --accent-100: 209 250 229;
      --accent-200: 167 243 208;
      --accent-300: 110 231 183;
      --accent-400: 52 211 153;
      --accent-500: 16 185 129;
      --accent-600: 5 150 105;
      --accent-700: 4 120 87;
      --accent-800: 6 95 70;
      --accent-900: 6 78 59;
    }

    .accent-amber {
      --accent-50: 255 251 235;
      --accent-100: 254 243 199;
      --accent-200: 253 230 138;
      --accent-300: 252 211 77;
      --accent-400: 251 191 36;
      --accent-500: 245 158 11;
      --accent-600: 217 119 6;
      --accent-700: 180 83 9;
      --accent-800: 146 64 14;
      --accent-900: 120 53 15;
    }

    .accent-sky {
      --accent-50: 240 249 255;
      --accent-100: 224 242 254;
      --accent-200: 186 230 253;
      --accent-300: 125 211 252;
      --accent-400: 56 189 248;
      --accent-500: 14 165 233;
      --accent-600: 2 132 199;
      --accent-700: 3 105 161;
      --accent-800: 7 89 133;
      --accent-900: 12 74 110;
    }

    .accent-violet {
      --accent-50: 245 243 255;
      --accent-100: 237 233 254;
      --accent-200: 221 214 254;
      --accent-300: 196 181 253;
      --accent-400: 167 139 250;
      --accent-500: 139 92 246;
      --accent-600: 124 58 237;
      --accent-700: 109 40 217;
      --accent-800: 91 33 182;
      --accent-900: 76 29 149;
    }

    /* Tutorial Styles */
    .tutorial-overlay {
      backdrop-filter: blur(2px);
    }

    .tutorial-highlight {
      position: relative;
      z-index: 60 !important;
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.6), 0 0 0 9999px rgba(0, 0, 0, 0.75) !important;
      border-radius: 1rem;
      animation: tutorial-pulse 2s ease-in-out infinite;
      pointer-events: none;
    }

    .tutorial-highlight-card {
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.6), 0 0 0 9999px rgba(0, 0, 0, 0.75) !important;
      border-radius: 1.5rem;
    }

    .tutorial-highlight-button {
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.6), 0 0 0 9999px rgba(0, 0, 0, 0.75) !important;
      border-radius: 9999px;
    }

    .tutorial-highlight-input {
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.6), 0 0 0 9999px rgba(0, 0, 0, 0.75) !important;
      border-radius: 1.25rem;
    }

    @keyframes tutorial-pulse {

      0%,
      100% {
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.6), 0 0 0 9999px rgba(0, 0, 0, 0.75);
      }

      50% {
        box-shadow: 0 0 0 8px rgba(99, 102, 241, 0.4), 0 0 0 9999px rgba(0, 0, 0, 0.75);
      }
    }

    .tutorial-bounce {
      animation: tutorial-bounce 1s ease-in-out infinite;
    }

    @keyframes tutorial-bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-5px);
      }
    }

    .tutorial-tooltip {
      position: fixed;
      z-index: 70;
      max-width: 320px;
      width: 90vw;
      animation: tooltip-appear 0.3s ease-out;
    }

    @media (min-width: 400px) {
      .tutorial-tooltip {
        width: 320px;
      }
    }

    @keyframes tooltip-appear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Hide Vue content until mounted */
    [v-cloak] {
      display: none !important;
    }

    /* Loading screen with glass effect */
    .app-loader {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.95) 100%);
      overflow: hidden;
      z-index: 9999;
    }

    .dark .app-loader {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
    }

    /* Animated floating shapes */
    .app-loader .shape {
      position: absolute;
      border-radius: 50%;
      filter: blur(40px);
      opacity: 0.6;
    }

    .app-loader .shape-1 {
      width: 320px;
      height: 320px;
      background: linear-gradient(135deg, #818cf8, #c084fc);
      top: 5%;
      left: 5%;
      animation: float-1 8s ease-in-out infinite;
    }

    .app-loader .shape-2 {
      width: 280px;
      height: 280px;
      background: linear-gradient(135deg, #f472b6, #fb7185);
      top: 55%;
      right: 5%;
      animation: float-2 10s ease-in-out infinite;
    }

    .app-loader .shape-3 {
      width: 240px;
      height: 240px;
      background: linear-gradient(135deg, #34d399, #2dd4bf);
      bottom: 15%;
      left: 15%;
      animation: float-3 7s ease-in-out infinite;
    }

    .app-loader .shape-4 {
      width: 200px;
      height: 200px;
      background: linear-gradient(135deg, #fbbf24, #fb923c);
      top: 25%;
      right: 20%;
      animation: float-4 9s ease-in-out infinite;
    }

    .app-loader .shape-5 {
      width: 180px;
      height: 180px;
      background: linear-gradient(135deg, #60a5fa, #818cf8);
      bottom: 10%;
      right: 30%;
      animation: float-5 11s ease-in-out infinite;
    }

    .app-loader .shape-6 {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, #a78bfa, #f472b6);
      top: 45%;
      left: 5%;
      animation: float-6 12s ease-in-out infinite;
    }

    @keyframes float-1 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(30px, 40px) scale(1.1); }
      50% { transform: translate(-20px, 60px) scale(0.95); }
      75% { transform: translate(40px, -20px) scale(1.05); }
    }

    @keyframes float-2 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(-40px, -30px) scale(1.15); }
      50% { transform: translate(30px, -50px) scale(0.9); }
      75% { transform: translate(-20px, 30px) scale(1.1); }
    }

    @keyframes float-3 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(50px, -40px) scale(1.2); }
      66% { transform: translate(-30px, -20px) scale(0.85); }
    }

    @keyframes float-4 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      50% { transform: translate(-30px, 50px) scale(1.1) rotate(180deg); }
    }

    @keyframes float-5 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(40px, -50px) scale(1.15); }
      50% { transform: translate(-25px, -30px) scale(0.95); }
      75% { transform: translate(35px, 40px) scale(1.1); }
    }

    @keyframes float-6 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      33% { transform: translate(45px, 30px) scale(1.2) rotate(60deg); }
      66% { transform: translate(-35px, 50px) scale(0.9) rotate(-30deg); }
    }

    /* Glass card container */
    .app-loader .glass-card {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.25rem;
      padding: 2.5rem 3rem;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .dark .app-loader .glass-card {
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .app-loader .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(var(--accent-300), 0.3);
      border-top-color: rgb(var(--accent-600));
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .dark .app-loader .spinner {
      border-color: rgba(var(--accent-700), 0.3);
      border-top-color: rgb(var(--accent-400));
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .app-loader .loading-text {
      font-size: 1.5rem;
      font-weight: 600;
      color: rgb(var(--accent-700));
      letter-spacing: 0.02em;
      animation: text-pulse 2s ease-in-out infinite;
    }

    .dark .app-loader .loading-text {
      color: rgb(var(--accent-300));
    }

    @keyframes text-pulse {
      0%, 100% {
        opacity: 0.6;
        transform: scale(0.98);
      }
      50% {
        opacity: 1;
        transform: scale(1.02);
      }
    }

    /* Toast Notification Styles */
    .toast-enter-active {
      animation: toast-in 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .toast-leave-active {
      animation: toast-out 0.35s cubic-bezier(0.4, 0, 1, 1) forwards;
    }
    @keyframes toast-in {
      0% { 
        opacity: 0; 
        transform: translateX(-50%) translateY(-30px) scale(0.92); 
        filter: blur(4px);
      }
      50% {
        filter: blur(0px);
      }
      100% { 
        opacity: 1; 
        transform: translateX(-50%) translateY(0) scale(1); 
        filter: blur(0px);
      }
    }
    @keyframes toast-out {
      0% { 
        opacity: 1; 
        transform: translateX(-50%) translateY(0) scale(1); 
      }
      100% { 
        opacity: 0; 
        transform: translateX(-50%) translateY(-15px) scale(0.96); 
      }
    }
    .toast-icon-success {
      animation: toast-icon-pop 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.15s both;
    }
    @keyframes toast-icon-pop {
      0% { 
        transform: scale(0) rotate(-45deg); 
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
      100% { 
        transform: scale(1) rotate(0deg); 
        opacity: 1;
      }
    }

    /* PWA-specific styles */
    @media (display-mode: standalone) {
      /* Remove system UI chrome when installed as PWA */
      body {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      }
      
      /* Prevent overscroll bounce in PWA */
      html, body {
        overscroll-behavior-y: contain;
      }
      
      /* Optimize for mobile PWA */
      .app-container {
        max-height: 100vh;
        overflow: hidden;
      }
    }

    /* iOS PWA status bar handling */
    @supports (-webkit-touch-callout: none) {
      .ios-status-bar-padding {
        padding-top: env(safe-area-inset-top);
      }
    }

    /* Enhanced touch targets for mobile */
    @media (hover: none) and (pointer: coarse) {
      button, [role="button"] {
        min-height: 44px;
        min-width: 44px;
      }
    }

    /* Prevent zoom on input focus in iOS Safari */
    @media screen and (max-width: 768px) {
      input, select, textarea {
        font-size: 16px !important;
      }
    }

    /* PWA app icon bounce animation for install prompt */
    @keyframes app-icon-bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }

    .app-icon-bounce {
      animation: app-icon-bounce 2s infinite;
    }
  </style>
</head>

<body
  class="bg-slate-50 dark:bg-slate-900 min-h-screen text-slate-800 dark:text-slate-200 flex items-center justify-center p-4 transition-colors duration-300">

  <div id="app" class="w-full max-w-md mx-auto pb-4">

    <!-- Loading Screen with Glass Effect (shown before Vue mounts) -->
    <div id="app-loader" class="app-loader">
      <!-- Animated floating shapes -->
      <div class="shape shape-1"></div>
      <div class="shape shape-2"></div>
      <div class="shape shape-3"></div>
      <div class="shape shape-4"></div>
      <div class="shape shape-5"></div>
      <div class="shape shape-6"></div>
      
      <!-- Glass card with spinner -->
      <div>
        <p class="loading-text">Načítavam</p>
      </div>
    </div>

    <!-- Main App Content (hidden with v-cloak until Vue mounts) -->
    <div v-cloak>

      <!-- TOAST NOTIFICATION (Apple-style) -->
      <transition
        enter-active-class="toast-enter-active"
        leave-active-class="toast-leave-active">
        <div v-if="toast.show" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] pointer-events-none">
          <div class="pointer-events-auto px-5 py-3 rounded-full shadow-2xl border flex items-center gap-3 min-w-[200px] max-w-[320px]"
            :class="{
              'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700': toast.type === 'info',
              'bg-emerald-50 dark:bg-emerald-900/40 border-emerald-200 dark:border-emerald-700': toast.type === 'success',
              'bg-red-50 dark:bg-red-900/40 border-red-200 dark:border-red-700': toast.type === 'error',
              'bg-amber-50 dark:bg-amber-900/40 border-amber-200 dark:border-amber-700': toast.type === 'warning'
            }">
            <!-- Icon -->
            <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center toast-icon-success"
              :class="{
                'bg-slate-100 dark:bg-slate-700': toast.type === 'info',
                'bg-emerald-100 dark:bg-emerald-800': toast.type === 'success',
                'bg-red-100 dark:bg-red-800': toast.type === 'error',
                'bg-amber-100 dark:bg-amber-800': toast.type === 'warning'
              }">
              <!-- Success Icon -->
              <svg v-if="toast.type === 'success'" class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
              </svg>
              <!-- Error Icon -->
              <svg v-else-if="toast.type === 'error'" class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
              </svg>
              <!-- Warning Icon -->
              <svg v-else-if="toast.type === 'warning'" class="w-5 h-5 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <!-- Info Icon -->
              <svg v-else class="w-5 h-5 text-slate-600 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <!-- Message -->
            <p class="text-sm font-semibold flex-1"
              :class="{
                'text-slate-700 dark:text-slate-200': toast.type === 'info',
                'text-emerald-700 dark:text-emerald-200': toast.type === 'success',
                'text-red-700 dark:text-red-200': toast.type === 'error',
                'text-amber-700 dark:text-amber-200': toast.type === 'warning'
              }">
              {{ toast.message }}
            </p>
          </div>
        </div>
      </transition>

      <!-- ADD CONTACT MODAL (Triggered by URL) -->
      <transition enter-active-class="transition duration-300 ease-out" enter-from-class="opacity-0 scale-95"
        enter-to-class="opacity-100 scale-100" leave-active-class="transition duration-200 ease-in"
        leave-from-class="opacity-100 scale-100" leave-to-class="opacity-0 scale-95">
        <div v-if="showAddContactModal" class="fixed inset-0 z-[90] flex items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
          <div
            class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 relative shadow-2xl border border-slate-200 dark:border-slate-700">
            <div
              class="w-12 h-12 bg-emerald-100 dark:bg-emerald-900 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-6 h-6 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
              </svg>
            </div>
            <h3 class="text-xl font-bold text-center mb-1 text-slate-800 dark:text-slate-200">Pridať kontakt</h3>
            <p class="text-center text-xs text-slate-500 mb-6">Nájdený Nostr odkaz. Uložte si tento kontakt pre rýchle
              platby.</p>

            <div class="space-y-4">
              <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Nostr Kľúč
                  (NPUB)</label>
                <input type="text" :value="newContactData.npub" readonly
                  class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-xl px-4 py-3 text-xs font-mono text-slate-500">
              </div>
              <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Meno
                  Kontaktu</label>
                <input type="text" v-model="newContactData.name" placeholder="napr. Janko Mrkvička"
                  class="w-full bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-sm focus:border-accent-500 outline-none font-bold">
              </div>
              <button @click="saveNewContact" :disabled="!newContactData.name"
                class="w-full py-3.5 rounded-xl bg-accent-600 text-white font-bold shadow-lg shadow-accent-200 dark:shadow-accent-900/40 hover:bg-accent-700 transition-transform active:scale-95 disabled:opacity-50">
                Uložiť do adresára
              </button>
              <button @click="showAddContactModal = false"
                class="w-full py-2 text-xs font-bold text-slate-400 hover:text-slate-600">Zrušiť</button>
            </div>
          </div>
        </div>
      </transition>

      <!-- NOSTR SEND MODAL -->
      <transition enter-active-class="transition duration-300 ease-out" enter-from-class="opacity-0 scale-95"
        enter-to-class="opacity-100 scale-100" leave-active-class="transition duration-200 ease-in"
        leave-from-class="opacity-100 scale-100" leave-to-class="opacity-0 scale-95">
        <div v-if="showNostrModal" class="fixed inset-0 z-[80] flex items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showNostrModal = false"></div>
          <div
            class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 relative shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col max-h-[90vh]">
            <h3 class="text-lg font-bold text-accent-600 dark:text-accent-400 mb-2">Poslať cez Nostr</h3>
            <p class="text-xs text-slate-500 mb-2">Vyberte príjemcov z adresára (môžete vybrať viacerých pre rozdelenie účtu).</p>

            <!-- Split Bill Indicator -->
            <div v-if="selectedContacts.length > 1" class="mb-3 px-3 py-2 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-xl flex flex-col gap-2">
              <!-- Toggle Switch for Split Bill -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-amber-600 dark:text-amber-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  <span class="text-xs font-medium text-amber-700 dark:text-amber-300">Rozdeliť účet</span>
                </div>
                <button @click="splitBillEnabled = !splitBillEnabled" 
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none"
                  :class="splitBillEnabled ? 'bg-amber-500' : 'bg-slate-300 dark:bg-slate-600'">
                  <span class="inline-block h-3.5 w-3.5 transform rounded-full bg-white shadow-sm transition-transform"
                    :class="splitBillEnabled ? 'translate-x-4' : 'translate-x-1'"></span>
                </button>
              </div>
              <!-- Amount Display -->
              <div v-if="payment.amount" class="flex items-center gap-2 pl-6">
                <template v-if="splitBillEnabled">
                  <span class="text-xs font-bold text-amber-800 dark:text-amber-200">{{ (payment.amount / selectedContacts.length).toFixed(2) }} € na osobu</span>
                  <span class="text-[10px] text-amber-600 dark:text-amber-400">(celkom {{ payment.amount }} €)</span>
                </template>
                <template v-else>
                  <span class="text-xs font-bold text-amber-800 dark:text-amber-200">{{ payment.amount }} € každému</span>
                  <span class="text-[10px] text-amber-600 dark:text-amber-400">({{ selectedContacts.length }}× rovnaká suma)</span>
                </template>
              </div>
              <!-- Mode Description -->
              <p class="text-[10px] text-amber-600 dark:text-amber-400 pl-6">
                {{ splitBillEnabled ? 'Suma bude rozdelená rovnomerne medzi ' + selectedContacts.length + ' kontaktov' : 'Každý kontakt dostane požiadavku na plnú sumu' }}
              </p>
            </div>

            <div class="mb-4 flex-1 min-h-0 flex flex-col">
              <!-- Search Bar -->
              <div class="relative mb-2">
                <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" v-model="contactSearch" placeholder="Hľadať kontakt..."
                  class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-xl pl-10 pr-4 py-3 text-sm outline-none focus:border-accent-500 text-slate-800 dark:text-slate-200">
              </div>

              <!-- Selected Contacts Display (Multiple) -->
              <div v-if="selectedContacts.length > 0" class="mb-2 space-y-1.5 max-h-24 overflow-y-auto">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-[10px] font-bold text-accent-600 dark:text-accent-400 uppercase tracking-wider">Vybraní príjemcovia ({{ selectedContacts.length }})</span>
                  <button @click="clearSelectedContacts" class="text-[10px] font-medium text-slate-400 hover:text-red-500 transition-colors">Zrušiť všetko</button>
                </div>
                <div v-for="contact in selectedContacts" :key="contact.npub" 
                  class="p-2 bg-accent-50 dark:bg-accent-900/30 border border-accent-300 dark:border-accent-600 rounded-lg flex items-center justify-between">
                  <div class="flex items-center gap-2 min-w-0">
                    <div class="w-6 h-6 rounded-full bg-accent-200 dark:bg-accent-700 flex items-center justify-center flex-shrink-0">
                      <span class="text-[10px] font-bold text-accent-700 dark:text-accent-200">{{ contact.name ? contact.name.charAt(0).toUpperCase() : '?' }}</span>
                    </div>
                    <div class="min-w-0">
                      <p class="text-xs font-bold text-accent-700 dark:text-accent-300 truncate">{{ contact.name }}</p>
                    </div>
                  </div>
                  <button @click="removeSelectedContact(contact)" class="text-accent-400 hover:text-red-500 p-0.5 flex-shrink-0 transition-colors">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- ADDRESS BOOK LIST (Always visible for multi-select) -->
              <div v-if="contacts.length > 0"
                class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden flex-1 min-h-0 max-h-48 overflow-y-auto">
                <div
                  class="bg-slate-50 dark:bg-slate-900 px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider sticky top-0 border-b border-slate-200 dark:border-slate-700 z-10">
                  Adresár ({{ filteredContacts.length }}) — kliknite pre výber</div>
                <div v-if="filteredContacts.length === 0" class="px-3 py-4 text-center text-xs text-slate-400 italic">Žiadne výsledky pre "{{ contactSearch }}"</div>
                <div v-for="contact in filteredContacts" :key="contact.npub" @click="toggleContactSelection(contact)"
                  class="px-3 py-2.5 cursor-pointer flex items-center justify-between group transition-colors border-b border-slate-100 dark:border-slate-700/50 last:border-0"
                  :class="isContactSelected(contact) ? 'bg-accent-100 dark:bg-accent-900/40' : 'bg-white dark:bg-slate-800 hover:bg-accent-50 dark:hover:bg-accent-900/20'">
                  <div class="flex items-center gap-2">
                    <!-- Checkbox Indicator -->
                    <div class="w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 transition-colors"
                      :class="isContactSelected(contact) ? 'bg-accent-500 border-accent-500' : 'border-slate-300 dark:border-slate-600'">
                      <svg v-if="isContactSelected(contact)" class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                    <div>
                      <p class="text-sm font-bold" :class="isContactSelected(contact) ? 'text-accent-700 dark:text-accent-300' : 'text-slate-700 dark:text-slate-200'">{{ contact.name }}</p>
                      <p class="text-[10px] text-slate-400 font-mono truncate max-w-[160px]">{{ contact.npub }}</p>
                    </div>
                  </div>
                </div>
              </div>
              <div v-else-if="contacts.length === 0" class="text-center py-6 text-slate-400 flex flex-col items-center">
                <svg class="w-10 h-10 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <p class="text-xs italic">Adresár je prázdny.</p>
                <p class="text-[10px] mt-1">Zdieľajte svoj link pre pridanie kontaktov.</p>
              </div>
            </div>

            <div class="flex gap-2 mt-auto">
              <button @click="showNostrModal = false; clearSelectedContacts()"
                class="flex-1 py-2.5 rounded-xl text-slate-500 font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">Zrušiť</button>
              <button @click="sendNostrPayment" :disabled="selectedContacts.length === 0 || isSendingNostr"
                class="flex-1 py-2.5 rounded-xl bg-accent-600 text-white font-bold text-sm hover:bg-accent-700 transition-colors disabled:opacity-50 flex items-center justify-center gap-2">
                <span v-if="isSendingNostr" class="animate-spin text-white">⏳</span>
                <template v-if="!isSendingNostr">
                  {{ selectedContacts.length > 1 ? 'Odoslať všetkým (' + selectedContacts.length + ')' : 'Odoslať' }}
                </template>
                <template v-else>Odosielam...</template>
              </button>
            </div>
          </div>
        </div>
      </transition>

      <!-- TUTORIAL TOOLTIP OVERLAY -->
      <div v-if="showTutorial" class="fixed inset-0 z-40 pointer-events-none"></div>

      <!-- Tutorial Tooltip -->
      <transition enter-active-class="transition duration-300 ease-out" enter-from-class="opacity-0 translate-y-2"
        enter-to-class="opacity-100 translate-y-0" leave-active-class="transition duration-200 ease-in"
        leave-from-class="opacity-100" leave-to-class="opacity-0">
        <div v-if="showTutorial" class="tutorial-tooltip" :style="tooltipPosition">
          <!-- Tooltip Card -->
          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
            <!-- Progress Bar -->
            <div class="h-1 bg-slate-200 dark:bg-slate-700">
              <div class="h-full bg-gradient-to-r from-accent-500 to-accent-600 transition-all duration-500"
                :style="{ width: ((tutorialStep + 1) / tutorialSteps.length * 100) + '%' }"></div>
            </div>

            <!-- Content -->
            <div class="p-4">
              <!-- Header with Icon -->
              <div class="flex items-start gap-3 mb-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 tutorial-bounce"
                  :style="{ background: tutorialSteps[tutorialStep].color }">
                  <span class="text-xl">{{ tutorialSteps[tutorialStep].icon }}</span>
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="font-bold text-slate-800 dark:text-slate-200 text-sm">
                    {{ tutorialSteps[tutorialStep].title }}
                  </h3>
                  <p class="text-slate-500 dark:text-slate-400 text-xs leading-relaxed mt-1">
                    {{ tutorialSteps[tutorialStep].description }}
                  </p>
                </div>
              </div>

              <!-- Step Counter -->
              <div class="flex items-center justify-between mb-3">
                <span class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase">
                  Krok {{ tutorialStep + 1 }} z {{ tutorialSteps.length }}
                </span>
                <div class="flex gap-1">
                  <div v-for="(step, idx) in tutorialSteps" :key="idx"
                    class="w-1.5 h-1.5 rounded-full transition-all duration-300"
                    :class="idx === tutorialStep ? 'bg-accent-500 w-4' : idx < tutorialStep ? 'bg-accent-300' : 'bg-slate-300 dark:bg-slate-600'">
                  </div>
                </div>
              </div>

              <!-- Buttons -->
              <div class="flex gap-2 items-center justify-between">
                <!-- Dismiss -->
                <button @click="skipTutorial"
                  class="py-2 px-4 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-500 text-xs font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                  Zavrieť
                </button>
                <!-- Pagination: Back / Forward -->
                <div class="flex gap-1">
                  <button @click="prevTutorialStep" :disabled="tutorialStep === 0"
                    class="w-8 h-8 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 text-sm font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <button @click="nextTutorialStep"
                    class="w-8 h-8 rounded-lg border text-sm font-semibold transition-colors flex items-center justify-center"
                    :class="tutorialStep === tutorialSteps.length - 1 ? 'border-accent-500 bg-accent-600 hover:bg-accent-700 text-white' : 'border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'">
                    <svg v-if="tutorialStep === tutorialSteps.length - 1" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <svg v-else class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </transition>

      <!-- Header -->
      <header class="flex justify-between items-center mb-4 px-2"
        :class="{ 'relative z-50': showTutorial && tutorialStep === 7 }">
        <div class="flex items-center gap-2">
          <button ref="settingsBtn"
            @click="showSettings = !showSettings; showHistory = false; showTemplates = false; isQrVisible = false"
            class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center justify-center"
            :class="[showSettings ? 'bg-accent-100 dark:bg-accent-900 text-accent-600 dark:text-accent-400' : 'text-slate-400 dark:text-slate-500', showTutorial && tutorialStep === 7 ? 'tutorial-highlight-button' : '']">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <button ref="templatesBtn"
            @click="showTemplates = !showTemplates; showHistory = false; showSettings = false; isQrVisible = false"
            class="relative p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center justify-center"
            :class="[showTemplates ? 'bg-emerald-100 dark:bg-emerald-900 text-emerald-600 dark:text-emerald-400' : 'text-slate-400 dark:text-slate-500', showTutorial && tutorialStep === 5 ? 'tutorial-highlight-button' : '']">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
            </svg>
          </button>
          <button ref="historyBtn"
            @click="showHistory = !showHistory; showTemplates = false; showSettings = false; isQrVisible = false"
            class="relative p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center justify-center"
            :class="[showHistory ? 'bg-accent-100 dark:bg-accent-900 text-accent-600 dark:text-accent-400' : 'text-slate-400 dark:text-slate-500', showTutorial && tutorialStep === 6 ? 'tutorial-highlight-button' : '']">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span v-if="unpaidPendingCount > 0 || hasIncomingRequests"
              class="absolute -top-1 -right-1 w-4 h-4 bg-red-600 text-white text-[10px] font-bold rounded-full flex items-center justify-center"
              :class="{ 'animate-pulse': hasIncomingRequests }">{{
              unpaidPendingCount > 99 ? '99' : (unpaidPendingCount || '!') }}</span>
          </button>
        </div>
      </header>

      <!-- Panels -->

      <!-- 1. ADD/EDIT ACCOUNT FORM (Moved to Card Area) -->

      <!-- 2. MAIN CARD AREA -->
      <div ref="cardArea" class="relative w-full mb-4 z-10 transition-all duration-500"
        :class="[showHistory || showTemplates || showSettings || isAddingProfile || isEditingProfile ? 'min-h-[500px]' : 'aspect-[1.586/1]', showTutorial && tutorialStep === 1 ? 'tutorial-highlight-card relative z-50' : '']">

        <!-- A. CAROUSEL -->
        <div class="absolute inset-0 w-full h-full transition-all duration-500 ease-spring"
          :class="(isQrVisible || showHistory || showTemplates || showSettings || isAddingProfile || isEditingProfile) ? 'opacity-0 scale-90 pointer-events-none' : 'opacity-100 scale-100 z-20'">
          <div ref="carouselRef"
            class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide w-full h-full items-center">
            <!-- Profile Cards -->
            <div v-for="profile in profiles" :key="profile.name"
              class="w-full h-full flex-shrink-0 snap-center relative px-0.5" :data-profile="profile.name">
              <div
                class="w-full h-full rounded-3xl text-white p-6 sm:p-7 flex flex-col justify-between shadow-xl border border-white/10 overflow-hidden relative"
                :style="{ background: getTagColor(profile.tag) }">
                <div class="absolute -top-10 -right-10 w-48 h-48 bg-white/10 rounded-full blur-3xl pointer-events-none">
                </div>

                <div class="flex justify-between items-start z-10">
                  <div class="flex items-start gap-3">
                    <div>
                      <div class="flex items-center gap-2 mb-1">

                        <span v-if="profile.tag"
                          class="text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full bg-white/20 text-white/80 flex items-center gap-1">
                          <span v-if="profile.emoji" class="text-[11px]">{{ getTagEmoji(profile.tag) }}</span>
                          <span>{{ getTagLabel(profile.tag) }}</span>
                        </span>
                      </div>
                      <h3 class="text-xl sm:text-2xl font-bold truncate max-w-[160px] tracking-tight">{{ profile.name }}
                      </h3>
                      <p class="text-white/60 text-xs sm:text-sm truncate max-w-[160px] mt-0.5">{{ profile.recipientName
                        }}</p>
                    </div>
                  </div>
                  <div class="flex gap-1">
                    <button @click.stop="toggleDefaultProfile(profile.name)"
                      class="p-2 hover:bg-white/10 rounded-full transition-colors -mt-2"
                      :class="profile.isDefault ? 'text-yellow-300' : 'text-white/60 hover:text-white'">
                      <svg class="w-5 h-5" :fill="profile.isDefault ? 'currentColor' : 'none'" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                      </svg>
                    </button>
                    <button @click.stop="editProfile(profile)"
                      class="text-white/60 hover:text-white p-2 hover:bg-white/10 rounded-full transition-colors -mt-2">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                      </svg>
                    </button>
                    <button @click.stop="deleteProfile(profile.name)"
                      class="text-white/60 hover:text-white p-2 hover:bg-white/10 rounded-full transition-colors -mr-2 -mt-2">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="z-10">
                  <div class="flex items-center gap-2 mb-1">
                    <p class="text-white/60 text-[10px] font-bold tracking-wider uppercase">IBAN</p>
                    <span v-if="getBankName(profile.iban)" class="text-[9px] font-medium text-white/40 bg-white/10 px-1.5 py-0.5 rounded">{{ getBankName(profile.iban) }}</span>
                  </div>
                  <div
                    class="bg-black/20 px-3 py-2 rounded-xl backdrop-blur-sm border border-white/10 inline-block max-w-full">
                    <p class="font-mono text-xs sm:text-base truncate">{{ formatIban(profile.iban) }}</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Add Button -->
            <div class="w-full h-full flex-shrink-0 snap-center px-0.5">
              <button @click="isAddingProfile = true"
                class="w-full h-full rounded-3xl border-2 border-dashed border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 hover:border-accent-400 dark:hover:border-accent-500 text-slate-400 dark:text-slate-500 hover:text-accent-600 dark:hover:text-accent-400 transition flex flex-col items-center justify-center gap-3 group">
                <div
                  class="w-14 h-14 rounded-full bg-slate-100 dark:bg-slate-700 group-hover:bg-accent-100 dark:group-hover:bg-accent-900 flex items-center justify-center transition-colors">
                  <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                </div>
                <span class="font-bold text-sm">Pridať Účet</span>
              </button>
            </div>
          </div>
        </div>

        <!-- B. QR RESULT -->
        <div
          class="absolute inset-0 w-full h-full bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-3xl border border-slate-200 dark:border-slate-700 p-4 sm:p-5 flex flex-col items-center justify-between shadow-2xl transition-all duration-500 ease-spring overflow-hidden"
          :class="isQrVisible ? 'opacity-100 scale-100 z-30 translate-y-0' : 'opacity-0 scale-95 pointer-events-none translate-y-4'">
          
          <!-- Decorative elements -->
          <div class="absolute top-0 right-0 w-32 h-32 bg-accent-500/5 rounded-full blur-3xl"></div>
          <div class="absolute bottom-0 left-0 w-24 h-24 bg-accent-400/5 rounded-full blur-2xl"></div>
          
          <div class="w-full flex items-stretch gap-4 sm:gap-5 flex-1 min-h-0 relative z-10">
            <!-- QR Code - Larger -->
            <div
              class="h-full aspect-square bg-gradient-to-br from-white to-slate-50 dark:from-slate-100 dark:to-white rounded-2xl flex items-center justify-center relative flex-shrink-0 p-2 sm:p-2.5 shadow-lg border-2 border-white dark:border-slate-50 ring-1 ring-slate-200/50 dark:ring-slate-300/30">
              <div ref="qrcodeContainer"
                class="mix-blend-multiply w-full h-full [&_canvas]:w-full [&_canvas]:h-full [&_img]:w-full [&_img]:h-full flex items-center justify-center">
              </div>
              <!-- QR Corner accents -->
              <div class="absolute top-1 left-1 w-3 h-3 border-t-2 border-l-2 border-accent-400 rounded-tl-md"></div>
              <div class="absolute top-1 right-1 w-3 h-3 border-t-2 border-r-2 border-accent-400 rounded-tr-md"></div>
              <div class="absolute bottom-1 left-1 w-3 h-3 border-b-2 border-l-2 border-accent-400 rounded-bl-md"></div>
              <div class="absolute bottom-1 right-1 w-3 h-3 border-b-2 border-r-2 border-accent-400 rounded-br-md"></div>
            </div>

            <!-- Payment Details - Right Side -->
            <div class="flex-1 flex flex-col justify-between py-1 min-w-0 overflow-hidden">
              <!-- Amount Section -->
              <div class="space-y-1">
                <p class="text-[10px] sm:text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Suma</p>
                <p class="text-3xl sm:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-accent-600 to-accent-500 tracking-tighter leading-none">
                  {{ payment.amount ? Number(payment.amount).toFixed(2) : '0.00' }}€
                </p>
              </div>

              <!-- Details Grid -->
              <div class="space-y-1 sm:space-y-2.5">
                <!-- Variable Symbol -->
                <div v-if="payment.vs" class="flex items-center justify-between gap-1.5 sm:gap-2 px-2 sm:px-2.5 py-1 sm:py-1.5 bg-slate-100/80 dark:bg-slate-700/50 rounded-lg backdrop-blur-sm border border-slate-200/50 dark:border-slate-600/50">
                  <div class="flex items-center gap-1 sm:gap-1.5">
                    <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    <span class="text-[9px] sm:text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase tracking-wider">VS</span>
                  </div>
                  <span class="text-[10px] sm:text-sm font-mono font-bold text-slate-800 dark:text-slate-200">{{ payment.vs }}</span>
                </div>

                <!-- Due Date -->
                <div v-if="payment.dueDate" class="flex items-center justify-between gap-1.5 sm:gap-2 px-2 sm:px-2.5 py-1 sm:py-1.5 bg-slate-100/80 dark:bg-slate-700/50 rounded-lg backdrop-blur-sm border border-slate-200/50 dark:border-slate-600/50">
                  <div class="flex items-center gap-1 sm:gap-1.5">
                    <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span class="text-[9px] sm:text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase tracking-wider">Splatnosť</span>
                  </div>
                  <span class="text-[10px] sm:text-sm font-bold text-slate-800 dark:text-slate-200">{{ new Date(payment.dueDate).toLocaleDateString('sk-SK') }}</span>
                </div>

                <!-- Message -->
                <div v-if="payment.msg" class="flex items-start gap-1.5 sm:gap-2 px-2 sm:px-2.5 py-1 sm:py-1.5 bg-slate-100/80 dark:bg-slate-700/50 rounded-lg backdrop-blur-sm border border-slate-200/50 dark:border-slate-600/50">
                  <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3 text-accent-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                  </svg>
                  <div class="flex-1 min-w-0">
                    <p class="text-[9px] sm:text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase tracking-wider mb-0.5">Správa</p>
                    <p class="text-[10px] sm:text-sm text-slate-700 dark:text-slate-300 line-clamp-2 leading-relaxed" :title="payment.msg">{{ payment.msg }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="w-full flex gap-2 sm:gap-3 mt-4 sm:mt-5 relative z-10">
            <!-- Share Button (icon only, like attach button) -->
            <button @click="sharePaymeLink"
              class="w-12 h-12 sm:w-13 sm:h-13 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:text-accent-600 dark:hover:text-accent-400 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-2xl shadow-lg hover:shadow-xl border-2 border-slate-200 dark:border-slate-700 hover:border-accent-300 dark:hover:border-accent-600 transition-all duration-300 flex items-center justify-center active:scale-95 group"
              :title="paymeLinkCopied ? 'Skopírované!' : 'Zdieľať'">
              <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                  d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
            </button>

            <!-- NOSTR Button (main action, like vyžiadať platbu) -->
            <button @click="showNostrModal = true"
              class="flex-1 h-12 sm:h-13 rounded-2xl font-bold text-base sm:text-lg shadow-lg hover:shadow-xl border-2 border-accent-600 dark:border-accent-500 bg-gradient-to-r from-accent-500 to-accent-600 hover:from-accent-600 hover:to-accent-700 text-white transition-all duration-300 flex items-center justify-center gap-2 active:scale-95 group">
              <svg class="w-5 h-5 transition-transform group-hover:rotate-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="tracking-wide">Vyžiadať</span>
            </button>
          </div>

        </div>

        <!-- C. TEMPLATES OVERLAY -->
        <div
          class="absolute inset-0 w-full h-full bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 flex flex-col shadow-2xl transition-all duration-500 ease-spring overflow-hidden"
          :class="showTemplates ? 'opacity-100 scale-100 z-30 translate-y-0' : 'opacity-0 scale-95 pointer-events-none translate-y-4'">
          <!-- Add/Edit Template Form (only when adding or editing) -->
          <div v-if="isAddingTemplate || isEditingTemplate"
            class="p-6 bg-white dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700">
            <h3 class="text-sm font-bold uppercase tracking-wider text-slate-400 dark:text-slate-500 mb-4">
              {{ isEditingTemplate ? 'Upraviť šablónu' : 'Nová šablóna' }}
            </h3>
            <div class="space-y-3">
              <input type="text" v-model="newTemplate.name" placeholder="Názov šablóny (napr. Mesačný nájom)"
                class="w-full bg-slate-50 dark:bg-slate-700 border-0 rounded-xl px-4 py-3 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none transition-shadow">
              <div class="grid grid-cols-2 gap-3">
                <input type="number" step="0.01" v-model="newTemplate.amount" placeholder="Suma (€)"
                  class="w-full bg-slate-50 dark:bg-slate-700 border-0 rounded-xl px-4 py-3 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none transition-shadow">
                <input type="text" v-model="newTemplate.vs" placeholder="VS (voliteľné)" maxlength="10"
                  class="w-full bg-slate-50 dark:bg-slate-700 border-0 rounded-xl px-4 py-3 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none font-mono transition-shadow">
              </div>
              <input type="text" v-model="newTemplate.msg" placeholder="Správa (voliteľné)"
                class="w-full bg-slate-50 dark:bg-slate-700 border-0 rounded-xl px-4 py-3 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none transition-shadow">
              <input type="date" v-model="newTemplate.dueDate" placeholder="Dátum splatnosti (voliteľné)"
                class="w-full bg-slate-50 dark:bg-slate-700 border-0 rounded-xl px-4 py-3 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none transition-shadow">
              <div class="flex gap-2 pt-2">
                <button @click="saveTemplate"
                  class="flex-1 py-3 rounded-full font-bold text-lg shadow-xl border-2 border-accent-600 dark:border-accent-500 bg-slate-100 dark:bg-slate-800 text-accent-600 dark:text-accent-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all active:scale-95">
                  {{ isEditingTemplate ? 'Uložiť zmeny' : 'Uložiť šablónu' }}
                </button>
                <button @click="cancelTemplateEdit"
                  class="px-4 py-3 rounded-xl font-bold text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors">
                  Zrušiť
                </button>
              </div>
            </div>
          </div>

          <!-- Templates List -->
          <div class="p-4 flex-1 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-3">
              <button @click="showTemplates = false"
                class="flex items-center gap-1 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-accent-600 dark:hover:text-accent-400 transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span>Späť</span>
              </button>
              <h3 class="text-sm font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Šablóny</h3>
              <button v-if="!isAddingTemplate && !isEditingTemplate" @click="isAddingTemplate = true"
                class="text-xs font-bold text-accent-600 dark:text-accent-400 hover:text-accent-700 dark:hover:text-accent-300 uppercase flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Pridať
              </button>
            </div>

            <!-- Search Bar -->
            <div v-if="templates.length > 0 && !isAddingTemplate && !isEditingTemplate" class="mb-3">
              <div class="relative">
                <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" v-model="templateSearch" placeholder="Hľadať podľa názvu, sumy, VS, správy..."
                  class="w-full bg-slate-100 dark:bg-slate-700 border-0 rounded-xl pl-10 pr-8 py-2.5 text-sm text-slate-700 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none">
                <button v-if="templateSearch" @click="templateSearch = ''"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div v-if="templates.length === 0 && !isAddingTemplate"
              class="text-center py-8 text-slate-400 dark:text-slate-500 flex-1 flex flex-col justify-center">
              <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
              </svg>
              <p class="text-sm">Žiadne šablóny</p>
              <p class="text-xs mt-1">Vytvorte si šablóny pre opakujúce sa platby</p>
              <button @click="isAddingTemplate = true"
                class="mt-3 px-4 py-2 bg-accent-100 dark:bg-accent-900 text-accent-600 dark:text-accent-400 rounded-xl text-sm font-bold hover:bg-accent-200 dark:hover:bg-accent-800 transition-colors">
                Vytvoriť prvú šablónu
              </button>
            </div>

            <!-- No results message -->
            <div v-else-if="templates.length > 0 && filteredTemplates.length === 0"
              class="text-center py-6 text-slate-400 dark:text-slate-500 flex-1 flex flex-col justify-center">
              <svg class="w-10 h-10 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <p class="text-sm">Žiadne výsledky pre "{{ templateSearch }}"</p>
            </div>

            <div v-else-if="filteredTemplates.length > 0" class="space-y-2 flex-1 overflow-y-auto scrollbar-hide">
              <div v-for="(template, index) in filteredTemplates" :key="template.name + index"
                class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors group">
                <button @click="applyTemplate(template)" class="flex-1 text-left min-w-0">
                  <div class="flex items-center gap-2">
                    <span class="font-bold text-slate-800 dark:text-slate-200 truncate">{{ template.name }}</span>
                  </div>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-sm font-bold text-accent-600 dark:text-accent-400">{{
                      Number(template.amount).toFixed(2) }}€</span>
                    <span v-if="template.vs"
                      class="text-[10px] bg-slate-200 dark:bg-slate-600 text-slate-500 dark:text-slate-400 px-1.5 py-0.5 rounded font-mono">VS:
                      {{ template.vs }}</span>
                    <span v-if="template.msg" class="text-[10px] text-slate-400 dark:text-slate-500 truncate">{{
                      template.msg }}</span>
                  </div>
                </button>
                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                  <button @click="editTemplate(template, templates.indexOf(template))"
                    class="p-1.5 text-slate-400 dark:text-slate-500 hover:text-accent-600 dark:hover:text-accent-400 hover:bg-accent-50 dark:hover:bg-accent-900 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                  </button>
                  <button @click="deleteTemplate(templates.indexOf(template))"
                    class="p-1.5 text-slate-400 dark:text-slate-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- D. HISTORY OVERLAY -->
        <div
          class="absolute inset-0 w-full h-full bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 flex flex-col shadow-2xl transition-all duration-500 ease-spring overflow-hidden"
          :class="showHistory ? 'opacity-100 scale-100 z-30 translate-y-0' : 'opacity-0 scale-95 pointer-events-none translate-y-4'">
          <!-- Analytics Summary -->
          <div class="p-3 bg-gradient-to-br from-indigo-600 to-violet-700 text-white flex-shrink-0">
            <div class="flex justify-between items-center mb-2">
              <button @click="showHistory = false"
                class="flex items-center gap-1 text-sm font-bold text-indigo-200 hover:text-white transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span>Späť</span>
              </button>
              <h3 class="text-sm font-bold uppercase tracking-wider text-indigo-200">Prehľad</h3>
            </div>

            <!-- Stats + Slider Row -->
            <div class="flex items-center gap-4">
              <!-- Compact Slider -->
              <div class="flex-1 min-w-0">
                <input type="range" 
                  :value="dateRangeOptions.indexOf(analyticsDateRange === 'custom' ? 'month' : analyticsDateRange)"
                  @input="analyticsDateRange = dateRangeOptions[$event.target.value]"
                  min="0" 
                  :max="dateRangeOptions.length - 1" 
                  step="1"
                  class="w-full h-1.5 bg-white/20 rounded-full appearance-none cursor-pointer
                    [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 
                    [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:shadow-lg
                    [&::-webkit-slider-thumb]:cursor-pointer
                    [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full 
                    [&::-moz-range-thumb]:bg-white [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer">
                <div class="flex justify-between mt-0.5">
                  <span v-for="(opt, idx) in dateRangeOptions" :key="opt" 
                    class="text-[7px] text-indigo-200/60 cursor-pointer hover:text-white transition-colors"
                    :class="{ 'text-white font-bold': analyticsDateRange === opt }"
                    @click="analyticsDateRange = opt">
                    {{ dateRangeShortLabels[opt] }}
                  </span>
                </div>
              </div>

              <!-- Numbers -->
              <div class="flex gap-4 flex-shrink-0">
                <div class="text-center">
                  <p class="text-xl font-extrabold">{{ filteredAnalytics.totalCount }}</p>
                  <p class="text-[9px] uppercase tracking-wider text-indigo-200">Platieb</p>
                </div>
                <div class="text-center">
                  <p class="text-xl font-extrabold">{{ filteredAnalytics.totalAmount.toFixed(0) }}€</p>
                  <p class="text-[9px] uppercase tracking-wider text-indigo-200">Celkom</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Carousel Breakdown -->
          <div class="bg-gradient-to-br from-indigo-700 to-violet-800 text-white px-3 py-2">
              <!-- Scrollable Area -->
              <div ref="analyticsCarousel" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide"
                @scroll="onAnalyticsScroll">

                <!-- Slide 1: By Category -->
                <div class="w-full flex-shrink-0 snap-center px-1">
                  <p class="text-[10px] uppercase tracking-wider text-indigo-200 mb-3 text-center">Podľa kategórie</p>
                  <div class="space-y-2">
                    <div v-if="filteredAnalytics.tagBreakdown.length === 0" class="text-xs text-white/50 text-center italic">Žiadne dáta</div>
                    <div v-for="tagStat in filteredAnalytics.tagBreakdown" :key="tagStat.tag"
                      class="flex items-center gap-2">
                      <div class="w-3 h-3 rounded-full flex-shrink-0" :style="{ background: tagStat.color }"></div>
                      <span class="text-xs font-medium flex-1">{{ tagStat.label }}</span>
                      <span class="text-xs font-bold">{{ tagStat.amount.toFixed(0) }}€</span>
                      <span class="text-[10px] text-indigo-200">({{ tagStat.count }}x)</span>
                    </div>
                  </div>
                  <!-- Visual Bar Chart -->
                  <div v-if="filteredAnalytics.tagBreakdown.length > 0" class="mt-3 flex gap-1 h-4 rounded-full overflow-hidden bg-white/10">
                    <div v-for="tagStat in filteredAnalytics.tagBreakdown" :key="tagStat.tag + '-bar'"
                      class="h-full transition-all duration-500"
                      :style="{ width: (tagStat.amount / filteredAnalytics.totalAmount * 100) + '%', background: tagStat.color }">
                    </div>
                  </div>
                </div>

                <!-- Slide 2: Paid vs Unpaid -->
                <div class="w-full flex-shrink-0 snap-center px-1">
                  <p class="text-[10px] uppercase tracking-wider text-indigo-200 mb-3 text-center">Zaplatené / Nezaplatené</p>
                  <div class="space-y-2">
                    <div v-if="filteredAnalytics.statusBreakdown.length === 0" class="text-xs text-white/50 text-center italic">Žiadne dáta</div>
                    <div v-for="stat in filteredAnalytics.statusBreakdown" :key="stat.label" class="flex items-center gap-2">
                      <div class="w-3 h-3 rounded-full flex-shrink-0" :class="stat.colorClass"></div>
                      <span class="text-xs font-medium flex-1">{{ stat.label }}</span>
                      <span class="text-xs font-bold">{{ stat.amount.toFixed(0) }}€</span>
                      <span class="text-[10px] text-indigo-200">({{ stat.count }}x)</span>
                    </div>
                  </div>
                   <!-- Visual Bar Chart -->
                   <div v-if="filteredAnalytics.statusBreakdown.length > 0" class="mt-3 flex gap-1 h-4 rounded-full overflow-hidden bg-white/10">
                    <div v-for="stat in filteredAnalytics.statusBreakdown" :key="stat.label + '-bar'"
                      class="h-full transition-all duration-500"
                      :class="stat.bgClass"
                      :style="{ width: (stat.amount / filteredAnalytics.totalAmount * 100) + '%' }">
                    </div>
                  </div>
                </div>

                <!-- Slide 3: Incoming vs Outgoing -->
                <div class="w-full flex-shrink-0 snap-center px-1">
                  <p class="text-[10px] uppercase tracking-wider text-indigo-200 mb-3 text-center">Žiadosti</p>
                  <div class="space-y-2">
                    <div v-if="filteredAnalytics.directionBreakdown.length === 0" class="text-xs text-white/50 text-center italic">Žiadne dáta</div>
                    <div v-for="stat in filteredAnalytics.directionBreakdown" :key="stat.label" class="flex items-center gap-2">
                      <div class="w-3 h-3 rounded-full flex-shrink-0" :class="stat.colorClass"></div>
                      <span class="text-xs font-medium flex-1">{{ stat.label }}</span>
                      <span class="text-xs font-bold">{{ stat.amount.toFixed(0) }}€</span>
                      <span class="text-[10px] text-indigo-200">({{ stat.count }}x)</span>
                    </div>
                  </div>
                   <!-- Visual Bar Chart -->
                   <div v-if="filteredAnalytics.directionBreakdown.length > 0" class="mt-3 flex gap-1 h-4 rounded-full overflow-hidden bg-white/10">
                    <div v-for="stat in filteredAnalytics.directionBreakdown" :key="stat.label + '-bar'"
                      class="h-full transition-all duration-500"
                      :class="stat.bgClass"
                      :style="{ width: (stat.amount / filteredAnalytics.totalAmount * 100) + '%' }">
                    </div>
                  </div>
                </div>

              </div>

              <!-- Pagination Dots -->
              <div class="flex justify-center gap-1.5 mt-2">
                <div v-for="i in 3" :key="i"
                  class="w-1.5 h-1.5 rounded-full transition-all duration-300"
                  :class="activeAnalyticsSlide === i-1 ? 'bg-white w-3' : 'bg-white/40'"></div>
              </div>
          </div>

          <!-- History List -->
          <div class="p-2 flex-1 min-h-0 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-sm font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider">História</h3>
              <div class="flex items-center gap-3">
                <button v-if="paymentHistory.length > 0" @click="exportHistoryCSV"
                  class="text-xs text-accent-500 hover:text-accent-600 dark:hover:text-accent-400 font-bold uppercase flex items-center gap-1">
                  <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  Export
                </button>
                <button v-if="paymentHistory.length > 0" @click="clearHistory"
                  class="text-xs text-red-400 hover:text-red-600 dark:hover:text-red-300 font-bold uppercase">Vymazať</button>
              </div>
            </div>

            <div v-if="paymentHistory.length === 0"
              class="text-center py-8 text-slate-400 dark:text-slate-500 flex-1 flex flex-col justify-center">
              <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
              <p class="text-sm">Žiadne platby</p>
            </div>

            <div v-else class="space-y-2 flex-1 min-h-0 overflow-y-auto scrollbar-hide">
              <div v-for="(item, index) in paymentHistory.slice().reverse()" :key="index"
                class="p-3 rounded-xl bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 border border-slate-200 dark:border-slate-600 shadow-sm transition-colors group relative overflow-hidden"
                :style="{ borderLeftWidth: '3px', borderLeftColor: item.status === 'incoming' ? '#a855f7' : getPaymentStatusStyle(item).borderColor }">

                <!-- Unified History Item Layout -->
                <div class="flex flex-col gap-2">
                  <!-- Top Row: Name/Title + Status Badge + Amount -->
                  <div class="flex items-start justify-between">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span v-if="item.status === 'incoming'"
                        class="text-[9px] px-1.5 py-0.5 rounded font-bold uppercase flex-shrink-0 bg-purple-100 dark:bg-purple-900/40 text-purple-600 dark:text-purple-400">
                        Žiadosť
                      </span>
                      <span v-else class="text-[9px] px-1.5 py-0.5 rounded font-bold uppercase flex-shrink-0"
                        :class="getPaymentStatusStyle(item).badgeClass">
                        {{ getPaymentStatusStyle(item).label }}
                      </span>
                    </div>
                    <p class="text-lg font-bold flex-shrink-0"
                      :class="item.status === 'incoming' ? 'text-purple-600 dark:text-purple-400' : 'text-indigo-600 dark:text-indigo-400'">
                      {{ Number(item.amount).toFixed(2) }}€
                    </p>
                  </div>

                  <!-- Meta Row: Date, VS (if applicable), Message -->
                  <div class="flex items-center gap-2 flex-wrap text-[11px]">
                    <span class="text-slate-400 dark:text-slate-500">{{ formatDate(item.timestamp) }}</span>
                    <span v-if="item.status !== 'incoming' && item.vs"
                      class="bg-slate-100 dark:bg-slate-600 text-slate-500 dark:text-slate-400 px-1.5 py-0.5 rounded font-mono">VS:
                      {{ item.vs || '-' }}</span>
                    <span v-if="item.msg" class="text-slate-400 dark:text-slate-500 italic truncate max-w-[150px]">„{{
                      item.msg }}"</span>
                  </div>

                  <!-- NOSTR ID Display (for outgoing items) -->
                  <div v-if="item.nostrId && item.status !== 'incoming'" class="flex items-center gap-1">
                    <span class="text-[10px] text-slate-400 font-mono">ID: {{ item.nostrId.slice(0,8) }}...</span>
                    <button @click="copyToClipboard(item.nostrId)"
                      class="text-[10px] text-indigo-500 font-bold hover:underline">COPY ID</button>
                  </div>

                  <!-- Action Buttons -->
                  <div class="flex gap-2 pt-1">
                    <!-- Incoming: Pay + Copy Link buttons -->
                    <template v-if="item.status === 'incoming'">
                      <a :href="item.paymeUrl" target="_blank"
                        class="flex-1 flex items-center justify-center gap-1 py-2 px-3 text-xs font-semibold text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30 hover:bg-purple-100 dark:hover:bg-purple-900/50 rounded-lg transition-colors"
                        title="Zaplatiť">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        <span>Zaplatiť</span>
                      </a>
    
                    </template>
                    <!-- Outgoing: Duplicate + Mark Paid buttons -->
                    <template v-else>
                      <button @click="duplicatePayment(item)"
                        class="flex-1 flex items-center justify-center gap-1 py-2 px-3 text-xs font-semibold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 rounded-lg transition-colors"
                        title="Duplikovať">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span>Kopírovať</span>
                      </button>
                      <button v-if="getPaymentStatusStyle(item).canMarkPaid" @click="markAsPaid(item.id)"
                        class="flex-1 flex items-center justify-center gap-1 py-2 px-3 text-xs font-semibold text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/30 hover:bg-green-100 dark:hover:bg-green-900/50 rounded-lg transition-colors"
                        title="Označiť ako zaplatené">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Zaplatené</span>
                      </button>
                    </template>
                    <!-- Delete button (always shown) -->
                    <button @click="deleteHistoryItem(index)"
                      class="py-2 px-3 text-xs font-semibold text-red-500 dark:text-red-400 bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-lg transition-colors"
                      title="Vymazať">
                      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- E. SETTINGS OVERLAY -->
        <div
          class="absolute inset-0 w-full h-full bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 flex flex-col shadow-2xl transition-all duration-500 ease-spring overflow-hidden"
          :class="showSettings ? 'opacity-100 scale-100 z-30 translate-y-0' : 'opacity-0 scale-95 pointer-events-none translate-y-4'">
          <!-- Settings Header -->
          <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex-shrink-0">
            <div class="flex justify-between items-center">
              <button @click="showSettings = false"
                class="flex items-center gap-1 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-accent-600 dark:hover:text-accent-400 transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span>Späť</span>
              </button>
              <h3 class="text-sm font-bold uppercase tracking-wider text-slate-600 dark:text-slate-300">Nastavenia</h3>
              <div class="w-12"></div>
            </div>
          </div>

          <!-- Settings Content -->
          <div class="p-4 flex-1 overflow-y-auto scrollbar-hide space-y-4">
            
            <!-- VZHĽAD SECTION -->
            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
              <div class="flex items-center gap-2 mb-4">
                <div class="w-8 h-8 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                  <svg class="w-4 h-4 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                  </svg>
                </div>
                <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Vzhľad</h4>
              </div>
              
              <!-- Theme Mode -->
              <div class="mb-4">
                <p class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Téma</p>
                <div class="flex gap-2">
                  <button @click="setThemeMode('light')"
                    class="flex items-center gap-1.5 px-3 py-2 rounded-lg border-2 transition-all"
                    :class="themeMode === 'light' ? 'border-accent-500 bg-accent-50 dark:bg-accent-900/30' : 'border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500'">
                    <svg class="w-4 h-4 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <span class="text-xs font-semibold"
                      :class="themeMode === 'light' ? 'text-accent-600 dark:text-accent-400' : 'text-slate-600 dark:text-slate-400'">Svetlý</span>
                  </button>
                  <button @click="setThemeMode('dark')"
                    class="flex items-center gap-1.5 px-3 py-2 rounded-lg border-2 transition-all"
                    :class="themeMode === 'dark' ? 'border-accent-500 bg-accent-50 dark:bg-accent-900/30' : 'border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500'">
                    <svg class="w-4 h-4 text-slate-400 dark:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    <span class="text-xs font-semibold"
                      :class="themeMode === 'dark' ? 'text-accent-600 dark:text-accent-400' : 'text-slate-600 dark:text-slate-400'">Tmavý</span>
                  </button>
                  <button @click="setThemeMode('system')"
                    class="flex items-center gap-1.5 px-3 py-2 rounded-lg border-2 transition-all"
                    :class="themeMode === 'system' ? 'border-accent-500 bg-accent-50 dark:bg-accent-900/30' : 'border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500'">
                    <svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span class="text-xs font-semibold"
                      :class="themeMode === 'system' ? 'text-accent-600 dark:text-accent-400' : 'text-slate-600 dark:text-slate-400'">Systém</span>
                  </button>
                </div>
              </div>

              <!-- Accent Color -->
              <div>
                <p class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Farba akcentu</p>
                <div class="flex flex-wrap gap-2">
                  <button v-for="color in accentColors" :key="color.name" @click="setAccentColor(color.name)"
                    class="w-10 h-10 rounded-full border-2 transition-all flex items-center justify-center shadow-sm bg-slate-100 dark:bg-slate-800 active:scale-95"
                    :class="[color.border, color.text, accentColor === color.name ? 'ring-2 ring-offset-2 ring-offset-slate-50 dark:ring-offset-slate-900' : 'hover:scale-110']"
                    :style="accentColor === color.name ? 'ring-color: ' + color.ring : ''">
                    <svg v-if="accentColor === color.name" class="w-5 h-5 text-current" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                    <div v-else class="w-3 h-3 rounded-full" :class="color.bg"></div>
                  </button>
                </div>
              </div>
            </div>

            <!-- ÚČET SECTION -->
            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                    <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                  </div>
                  <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Nostr Účet</h4>
                </div>
                <span class="text-[10px] flex items-center gap-1 font-bold">
                  <span class="w-2 h-2 rounded-full" :class="connectedRelays > 0 ? 'bg-green-500' : 'bg-red-500'"></span>
                  <span :class="connectedRelays > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'">{{ connectedRelays }} Relays</span>
                </span>
              </div>

              <!-- NPUB -->
              <div class="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200 dark:border-slate-700 mb-2">
                <label class="text-[10px] text-slate-500 block mb-1">Verejný Kľúč (NPUB)</label>
                <div class="flex gap-2 items-center">
                  <input type="text" :value="myNpub" class="w-full bg-transparent text-xs text-slate-700 dark:text-slate-300 font-mono truncate outline-none" readonly>
                  <button @click="generateShareLink" title="Zdieľať" class="p-1.5 text-accent-600 dark:text-accent-400 hover:bg-accent-50 dark:hover:bg-accent-900/30 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- NSEC -->
              <div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-3 border border-red-200 dark:border-red-800 mb-3">
                <label class="text-[10px] text-red-500 dark:text-red-400 block mb-1">⚠️ Súkromný Kľúč (NSEC)</label>
                <div class="flex gap-2 items-center">
                  <input type="password" :value="myNsec" class="w-full bg-transparent text-xs text-slate-700 dark:text-slate-300 font-mono truncate outline-none" readonly>
                  <button @click="copyNsec" title="Kopírovať (opatrne!)" class="p-1.5 text-red-500 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                  </button>
                </div>
              </div>

              <button @click="showPrivKeyInput = !showPrivKeyInput"
                class="text-xs text-slate-500 underline hover:text-slate-800 dark:hover:text-slate-300 transition-colors">{{
                showPrivKeyInput ? 'Skryť' : 'Prihlásiť sa iným kľúčom' }}</button>

              <div v-if="showPrivKeyInput" class="mt-2 bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                <input type="text" v-model="inputPrivKey" placeholder="nsec1..."
                  class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-xs text-slate-800 dark:text-slate-200 outline-none focus:border-accent-500 mb-2">
                <button @click="loginWithNewKey"
                  class="w-full bg-accent-600 hover:bg-accent-700 text-white py-2 rounded-lg text-xs font-bold transition-colors">Uložiť a Prihlásiť</button>
              </div>
            </div>

            <!-- KONTAKTY SECTION -->
            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                    <svg class="w-4 h-4 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  </div>
                  <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Kontakty</h4>
                </div>
                <span class="text-[10px] text-slate-400 font-medium bg-slate-200 dark:bg-slate-700 px-2 py-0.5 rounded-full">{{ contacts.length }}</span>
              </div>

              <div v-if="contacts.length === 0" class="text-center py-4 text-slate-400">
                <p class="text-xs">Zatiaľ nemáte žiadne kontakty</p>
              </div>

              <div v-else class="space-y-2 max-h-40 overflow-y-auto scrollbar-hide">
                <div v-for="contact in contacts" :key="contact.npub"
                  class="flex items-center gap-2 p-2 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                  <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-400 to-accent-600 flex items-center justify-center text-white font-bold text-xs flex-shrink-0">
                    {{ contact.name ? contact.name.charAt(0).toUpperCase() : '?' }}
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-xs font-semibold text-slate-700 dark:text-slate-200 truncate">{{ contact.name }}</p>
                    <p class="text-[9px] text-slate-400 font-mono truncate">{{ contact.npub.slice(0, 12) }}...</p>
                  </div>
                  <button @click="deleteContact(contact.npub)"
                    class="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors"
                    title="Odstrániť">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- INTEGRÁCIE SECTION -->
            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
              <div class="flex items-center gap-2 mb-4">
                <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                  <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                </div>
                <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Integrácie</h4>
              </div>

              <!-- Gemini API Key -->
              <div>
                <p class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">AI (Gemini)</p>
                <input type="password" v-model="geminiApiKey" placeholder="Vložte Gemini API Kľúč"
                  class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-2.5 text-xs text-slate-800 dark:text-slate-200 focus:border-accent-500 focus:ring-0 outline-none transition-colors">
                <div class="mt-1.5 text-[10px] text-slate-400">
                  <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-accent-500">Získať API kľúč zadarmo</a>
                </div>
              </div>
            </div>

            <!-- POMOCNÍK SECTION -->
            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
              <button @click="restartTutorial"
                class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 dark:border-slate-600 hover:border-accent-400 dark:hover:border-accent-500 hover:bg-white dark:hover:bg-slate-800 transition-all group">
                <div class="w-8 h-8 rounded-lg bg-accent-100 dark:bg-accent-900 flex items-center justify-center group-hover:scale-110 transition-transform">
                  <svg class="w-4 h-4 text-accent-600 dark:text-accent-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                  </svg>
                </div>
                <div class="text-left">
                  <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">Zobraziť tutoriál</p>
                  <p class="text-[10px] text-slate-400 dark:text-slate-500">Prejsť si znova úvod do aplikácie</p>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- F. ADD/EDIT ACCOUNT OVERLAY -->
        <div
          class="absolute inset-0 w-full h-full bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 flex flex-col shadow-2xl transition-all duration-500 ease-spring overflow-hidden"
          :class="(isAddingProfile || isEditingProfile) ? 'opacity-100 scale-100 z-30 translate-y-0' : 'opacity-0 scale-95 pointer-events-none translate-y-4'">
          <!-- Header -->
          <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex-shrink-0">
            <div class="flex justify-between items-center">
              <button @click="cancelProfileForm"
                class="flex items-center gap-1 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-accent-600 dark:hover:text-accent-400 transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span>Späť</span>
              </button>
              <h3 class="text-sm font-bold uppercase tracking-wider text-slate-600 dark:text-slate-300">{{
                isEditingProfile ? 'Upraviť Účet' : 'Nový Účet' }}</h3>
              <div class="w-12"></div>
            </div>
          </div>

          <!-- Content -->
          <div class="p-5 flex-1 overflow-y-auto scrollbar-hide space-y-3">
            <input type="text" v-model="newProfile.name" placeholder="Názov (napr. Firma)" :disabled="isEditingProfile"
              :class="isEditingProfile ? 'bg-slate-100 dark:bg-slate-700 text-slate-400 dark:text-slate-500' : 'bg-slate-50 dark:bg-slate-700'"
              class="w-full border-0 rounded-2xl px-5 py-3.5 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none transition-shadow">
            <input type="text" v-model="newProfile.recipientName" placeholder="Meno príjemcu"
              class="w-full bg-slate-50 dark:bg-slate-700 border-0 rounded-2xl px-5 py-3.5 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none transition-shadow">
            <div>
              <input type="text" v-model="newProfile.iban" placeholder="IBAN (napr. SK31 1200 0000 1987 4263 7541)"
                class="w-full bg-slate-50 dark:bg-slate-700 border-2 rounded-2xl px-5 py-3.5 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none transition-shadow font-mono uppercase"
                :class="ibanError ? 'border-red-400 dark:border-red-500' : 'border-transparent'">
              <p v-if="ibanError" class="mt-1 px-2 text-xs text-red-500 dark:text-red-400 font-medium">{{ ibanError }}</p>
              <p v-else-if="newProfile.iban && !ibanError" class="mt-1 px-2 text-xs text-emerald-500 dark:text-emerald-400 font-medium">✓ Platný IBAN</p>
            </div>

            <!-- Tag Selection with Colors and Icons -->
            <div class="px-1">
              <p class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Štítok &
                Ikona</p>
              <div class="flex gap-2 flex-wrap mb-3">
                <button v-for="tag in allTags" :key="tag.name" @click="selectTag(tag)" type="button"
                  class="px-3 py-1.5 rounded-xl transition-all duration-200 border-2 text-sm font-bold text-white flex items-center gap-1.5"
                  :style="{ background: tag.color }"
                  :class="newProfile.tag === tag.name ? 'border-slate-800 scale-105 shadow-lg' : 'border-transparent hover:scale-105 opacity-80 hover:opacity-100'">
                  <span class="text-base">{{ tag.emoji }}</span>
                  <span>{{ tag.label }}</span>
                </button>
                <button @click="showCustomTagForm = !showCustomTagForm" type="button"
                  class="px-3 py-1.5 rounded-xl transition-all duration-200 border-2 border-dashed border-slate-300 text-sm font-bold text-slate-400 hover:border-accent-400 hover:text-accent-600">
                  + Vlastný
                </button>
              </div>

              <!-- Custom Tag Form -->
              <div v-if="showCustomTagForm" class="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl space-y-3">
                <input type="text" v-model="customTag.label" placeholder="Názov štítku"
                  class="w-full bg-white dark:bg-slate-600 border-0 rounded-lg px-3 py-2 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-accent-500 outline-none">

                <div class="flex gap-3">
                  <!-- Emoji selection -->
                  <div class="flex-1">
                    <p class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-1">
                      Ikona
                    </p>
                    <div class="flex gap-1 flex-wrap">
                      <button v-for="emoji in availableEmojis.slice(0, 6)" :key="emoji" @click="customTag.emoji = emoji"
                        type="button"
                        class="w-7 h-7 rounded-lg transition-all duration-200 border-2 text-sm flex items-center justify-center bg-white dark:bg-slate-600 hover:bg-slate-100 dark:hover:bg-slate-500"
                        :class="customTag.emoji === emoji ? 'border-accent-500 scale-110' : 'border-transparent hover:scale-105'">
                        {{ emoji }}
                      </button>
                    </div>
                  </div>

                  <!-- Color selection -->
                  <div class="flex-1">
                    <p class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-1">
                      Farba
                    </p>
                    <div class="flex gap-1 flex-wrap">
                      <button v-for="color in tagColors.slice(0, 6)" :key="color" @click="customTag.color = color"
                        type="button" class="w-7 h-7 rounded-lg transition-all duration-200 border-2"
                        :style="{ background: color }"
                        :class="customTag.color === color ? 'border-slate-800 scale-110' : 'border-transparent hover:scale-105'">
                      </button>
                    </div>
                  </div>
                </div>
                <button @click="addCustomTag" type="button"
                  class="w-full py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors">
                  Pridať štítok
                </button>
              </div>
            </div>
            <button @click="saveProfile"
              class="w-full mt-5 py-3.5 rounded-full font-bold text-lg shadow-xl border-2 border-accent-600 dark:border-accent-500 bg-slate-100 dark:bg-slate-800 text-accent-600 dark:text-accent-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all active:scale-95">{{
              isEditingProfile ? 'Uložiť Zmeny' : 'Uložiť Účet' }}</button>
          </div>
        </div>
      </div>

      <!-- 3. INPUTS (Redesigned: Compact) -->
      <div ref="inputsArea" class="space-y-3 px-2 mt-2 transition-all duration-500"
        :class="[isQrVisible || showHistory || showTemplates || showSettings || isAddingProfile || isEditingProfile ? 'opacity-40 blur-[1px] pointer-events-none' : 'opacity-100', showTutorial && tutorialStep === 2 ? 'relative z-50' : '']">

        <!-- Suma with Inline Calculator (wrapped for dropdown positioning) -->
        <div class="relative" :class="showTutorial && tutorialStep === 2 ? 'tutorial-highlight-input' : ''">
          <div
            class="bg-white dark:bg-slate-800 rounded-[1.25rem] shadow-sm border border-slate-200 dark:border-slate-700 transition-all overflow-hidden focus-within:border-accent-500 focus-within:ring-2 focus-within:ring-accent-500/20">
            <!-- Main Input Row (also serves as calculator display) -->
            <div class="h-16 px-5 flex flex-col justify-center">
              <!-- Expression display when calculator is active -->
              <div class="flex items-center justify-between">
                <label class="text-[10px] font-bold uppercase tracking-wider mb-0.5 transition-colors"
                  :class="showCalculator && calcDisplay ? 'text-accent-500 dark:text-accent-400' : 'text-slate-400 dark:text-slate-500'">
                  <span v-if="showCalculator && calcDisplay" class="font-mono">{{ calcDisplay }}</span>
                  <span v-else>Suma</span>
                </label>
                <span v-if="showCalculator && calcDisplay"
                  class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">=</span>
              </div>
              <div class="flex items-center justify-center">
                <!-- Show calculated result when calculator is active, otherwise show normal input -->
                <input v-if="!showCalculator" type="number" step="0.01" v-model="payment.amount"
                  @focus="showAmountSuggestions = true" @blur="hideAmountSuggestions"
                  class="w-full text-xl font-bold text-slate-800 dark:text-slate-200 outline-none bg-transparent placeholder-slate-300 dark:placeholder-slate-600"
                  placeholder="0.00">
                <p v-else class="w-full text-xl font-bold font-mono transition-colors"
                  :class="calcResult !== null ? 'text-accent-600 dark:text-accent-400' : 'text-slate-300 dark:text-slate-600'">
                  {{ calcResult !== null ? calcResult.toFixed(2) : '0.00' }}
                </p>
                <button @click.prevent="toggleCalculator" type="button" class="ml-2 p-1.5 rounded-lg transition-colors"
                  :class="showCalculator ? 'text-accent-600' : 'text-slate-400 dark:text-slate-500 hover:text-accent-600'">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
            </div>

            <!-- Inline Calculator Keypad (Expandable) -->
            <transition enter-active-class="transition-all duration-300 ease-out" enter-from-class="max-h-0 opacity-0"
              enter-to-class="max-h-[320px] opacity-100" leave-active-class="transition-all duration-200 ease-in"
              leave-from-class="max-h-[320px] opacity-100" leave-to-class="max-h-0 opacity-0">
              <div v-if="showCalculator" class="border-t border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-4 bg-slate-50 dark:bg-slate-800/50">
                  <!-- Compact Keypad -->
                  <div class="grid grid-cols-4 gap-1.5">
                    <!-- Number row 7-9 with divide -->
                    <button @click="calcInput('7')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">7</button>
                    <button @click="calcInput('8')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">8</button>
                    <button @click="calcInput('9')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">9</button>
                    <button @click="calcInput('÷')"
                      class="py-2.5 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold text-base hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors active:scale-95">÷</button>

                    <!-- Number row 4-6 with multiply -->
                    <button @click="calcInput('4')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">4</button>
                    <button @click="calcInput('5')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">5</button>
                    <button @click="calcInput('6')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">6</button>
                    <button @click="calcInput('×')"
                      class="py-2.5 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold text-base hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors active:scale-95">×</button>

                    <!-- Number row 1-3 with minus -->
                    <button @click="calcInput('1')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">1</button>
                    <button @click="calcInput('2')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">2</button>
                    <button @click="calcInput('3')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">3</button>
                    <button @click="calcInput('-')"
                      class="py-2.5 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold text-base hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors active:scale-95">−</button>

                    <!-- Bottom row: 0, decimal, plus -->
                    <button @click="calcInput('0')"
                      class="col-span-2 py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">0</button>
                    <button @click="calcInput('.')"
                      class="py-2.5 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-bold text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 active:scale-95">.</button>
                    <button @click="calcInput('+')"
                      class="py-2.5 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold text-base hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors active:scale-95">+</button>

                    <!-- Apply button spans full width -->
                    <button @click="calcApply"
                      class="col-span-4 py-3 rounded-lg bg-green-500 dark:bg-green-600 text-white font-bold text-sm hover:bg-green-600 dark:hover:bg-green-500 transition-colors active:scale-95 flex items-center justify-center gap-1">
                      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                      </svg>
                      Použiť
                    </button>
                  </div>
                </div>
              </div>
            </transition>
          </div>

          <!-- Amount Suggestions Dropdown (outside overflow-hidden container) -->
          <div v-if="showAmountSuggestions && recentAmounts.length > 0 && !showCalculator"
            class="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-slate-700 rounded-xl shadow-lg border border-slate-200 dark:border-slate-600 z-50 overflow-hidden">
            <div class="flex items-center gap-2 p-2">
              <p
                class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider whitespace-nowrap">
                Nedávne:</p>
              <div class="flex gap-1 overflow-x-auto scrollbar-hide">
                <button v-for="amt in recentAmounts" :key="amt" @mousedown.prevent="selectAmount(amt)"
                  class="px-3 py-1.5 bg-slate-100 dark:bg-slate-600 hover:bg-indigo-100 dark:hover:bg-indigo-800 text-slate-700 dark:text-slate-200 hover:text-indigo-700 dark:hover:text-indigo-300 rounded-lg text-sm font-bold transition-colors whitespace-nowrap flex-shrink-0">
                  {{ amt.toFixed(2) }}€
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Grid for VS and Date -->
        <div class="grid grid-cols-1 gap-3">
          <!-- VS -->
          <div
            class="h-14 bg-white dark:bg-slate-800 px-5 rounded-[1.25rem] shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-center relative focus-within:border-accent-500 focus-within:ring-2 focus-within:ring-accent-500/20 transition-all">
            <label
              class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-0.5">VS</label>
            <input type="text" v-model="payment.vs" maxlength="10" placeholder="----"
              class="w-full text-lg font-bold text-slate-800 dark:text-slate-200 font-mono outline-none bg-transparent placeholder-slate-300 dark:placeholder-slate-600 pr-4">
          </div>

          <!-- Dátum splatnosti -->
          <div
            class="h-14 bg-white dark:bg-slate-800 px-5 rounded-[1.25rem] shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-center relative focus-within:border-accent-500 focus-within:ring-2 focus-within:ring-accent-500/20 transition-all">
            <label class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-0.5">Dátum
              splatnosti</label>
            <input type="date" v-model="payment.dueDate"
              class="appearance-none w-full text-base font-bold text-slate-800 dark:text-slate-200 outline-none bg-transparent placeholder-slate-300 dark:placeholder-slate-600 [&::-webkit-calendar-picker-indicator]:opacity-0 [&::-webkit-calendar-picker-indicator]:absolute [&::-webkit-calendar-picker-indicator]:right-0 [&::-webkit-calendar-picker-indicator]:w-full [&::-webkit-calendar-picker-indicator]:h-full [&::-webkit-calendar-picker-indicator]:cursor-pointer">
            <div
              class="absolute top-1/2 -translate-y-1/2 right-4 text-slate-300 dark:text-slate-600 pointer-events-none mt-1">
            </div>
          </div>
        </div>

        <!-- Správa -->
        <div
          class="h-14 bg-white dark:bg-slate-800 px-5 rounded-[1.25rem] shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-center relative focus-within:border-accent-500 focus-within:ring-2 focus-within:ring-accent-500/20 transition-all">
          <label
            class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-0.5">Správa</label>
          <input type="text" v-model="payment.msg" placeholder="Poznámka..."
            class="w-full text-base font-bold text-slate-800 dark:text-slate-200 outline-none bg-transparent placeholder-slate-300 dark:placeholder-slate-600 truncate">
        </div>
      </div>

      <!-- 4. ACTION BUTTONS (Main action + Additional features) -->
      <div class="mt-6 px-1" :class="showTutorial && (tutorialStep === 3 || tutorialStep === 4) ? 'relative z-50' : ''">
        <!-- All Buttons on Same Row -->
        <div class="flex gap-3 items-center h-14">
          <!-- File Attachment Button -->
          <div class="flex gap-3"
            :class="isQrVisible || showHistory || showTemplates || showSettings || isAddingProfile || isEditingProfile ? 'opacity-40 blur-[1px] pointer-events-none' : 'opacity-100'">
            <button ref="attachBtn" @click="attachFile" :disabled="isProcessingFile"
              class="w-14 h-14 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full shadow-xl border border-slate-200 dark:border-slate-700 transition-all flex items-center justify-center active:scale-95 disabled:opacity-70 disabled:cursor-wait"
              :class="showTutorial && tutorialStep === 3 ? 'tutorial-highlight-button' : ''"
              title="Naskenovať účtenku (AI)">
              <!-- Spinner when processing -->
              <svg v-if="isProcessingFile" class="animate-spin h-6 w-6 text-accent-600 dark:text-accent-400"
                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
              </svg>

              <!-- Icon when idle -->
              <svg v-else class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </button>
          </div>

          <!-- Main Action Button -->
          <div class="flex-1 relative h-full"
            :class="showTutorial && tutorialStep === 4 ? 'tutorial-highlight-button' : ''">
            <transition mode="out-in" enter-active-class="transition duration-200 ease-out"
              enter-from-class="transform scale-90 opacity-0" enter-to-class="transform scale-100 opacity-100"
              leave-active-class="transition duration-150 ease-in" leave-from-class="transform scale-100 opacity-100"
              leave-to-class="transform scale-90 opacity-0">
              <button v-if="!isQrVisible" key="generate" @click="generateQRCode"
                :disabled="!activeProfileName || !payment.amount"
                class="absolute inset-0 w-full h-full rounded-full font-bold text-lg shadow-xl border-2 border-accent-600 dark:border-accent-500 bg-slate-100 dark:bg-slate-800 text-accent-600 dark:text-accent-400 hover:bg-slate-200 dark:hover:bg-slate-700 disabled:opacity-70 disabled:cursor-not-allowed z-20 transition-all active:scale-95">
                Vyžiadať platbu
              </button>

              <button v-else key="close" @click="closeQr"
                class="absolute inset-0 w-full h-full rounded-full font-bold text-lg shadow-xl bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 hover:text-slate-800 dark:hover:text-slate-200 border border-slate-200 dark:border-slate-600 z-20 transition-all active:scale-95">
                Zatvoriť
              </button>
            </transition>
          </div>
        </div>
      </div>


    </div><!-- end v-cloak wrapper -->

  </div>

  <script type="module">
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    // NOSTR RELAY CONFIGURATION
    const RELAYS = [
      'wss://relay.damus.io',
      'wss://nos.lol',
      'wss://relay.primal.net'
    ];

    createApp({
      setup() {
        // Elements
        const carouselRef = ref(null);
        const qrcodeContainer = ref(null);
        const analyticsCarousel = ref(null);

        // App State
        const isDarkMode = ref(false);
        const showSettings = ref(false);
        const settingsTab = ref('appearance'); // 'appearance' or 'account'
        const themeMode = ref('system'); // 'light', 'dark', 'system'
        const accentColor = ref('indigo');
        const accentColors = [
          { name: 'indigo', bg: 'bg-indigo-500', border: 'border-indigo-500', text: 'text-indigo-500', ring: '#6366f1' },
          { name: 'rose', bg: 'bg-rose-500', border: 'border-rose-500', text: 'text-rose-500', ring: '#f43f5e' },
          { name: 'emerald', bg: 'bg-emerald-500', border: 'border-emerald-500', text: 'text-emerald-500', ring: '#10b981' },
          { name: 'amber', bg: 'bg-amber-500', border: 'border-amber-500', text: 'text-amber-500', ring: '#f59e0b' },
          { name: 'sky', bg: 'bg-sky-500', border: 'border-sky-500', text: 'text-sky-500', ring: '#0ea5e9' },
          { name: 'violet', bg: 'bg-violet-500', border: 'border-violet-500', text: 'text-violet-500', ring: '#8b5cf6' },
        ];
        const isAddingProfile = ref(false);
        const isEditingProfile = ref(false);
        const isQrVisible = ref(false);
        const paymeLinkCopied = ref(false);
        const activeProfileName = ref('');
        const profiles = ref([]);
        const showHistory = ref(false);
        const paymentHistory = ref([]);
        const showTemplates = ref(false);
        const templates = ref([]);
        const newTemplate = ref({ name: '', amount: '', vs: '', msg: '', dueDate: '' });
        const templateSearch = ref('');

        // AI / Gemini State
        const geminiApiKey = ref('');
        const isProcessingFile = ref(false);
        const attachedFile = ref(null);

        // NOSTR STATE
        const myPrivKey = ref(''); // nsec for UI
        const myPubKey = ref('');  // hex
        const myNpub = ref('');    // npub
        const myNsec = computed(() => myPrivKey.value); // Expose nsec for copying
        const showNostrModal = ref(false);
        const selectedContacts = ref([]); // Array for multiple contact selection (split bill)
        const splitBillEnabled = ref(true); // Toggle for splitting bill vs same amount to all
        const contactSearch = ref('');
        const isSendingNostr = ref(false);
        const connectedRelays = ref(0);
        const pool = ref(null);
        const showPrivKeyInput = ref(false);
        const inputPrivKey = ref('');

        // Toast Notification State
        const toast = ref({ show: false, message: '', type: 'success' });
        let toastTimeout = null;
        const showToast = (message, type = 'success', duration = 2500) => {
          if (toastTimeout) clearTimeout(toastTimeout);
          toast.value = { show: true, message, type };
          toastTimeout = setTimeout(() => {
            toast.value.show = false;
          }, duration);
        };

        // NOSTR ADDRESS BOOK & DEEP LINK
        const contacts = ref([]);
        const showAddContactModal = ref(false);
        const newContactData = ref({ npub: '', name: '' });

        // Tutorial state
        const showTutorial = ref(false);
        const tutorialStep = ref(0);
        const tutorialCompleted = ref(false);

        // Refs for tutorial targets
        const settingsBtn = ref(null);
        const templatesBtn = ref(null);
        const historyBtn = ref(null);
        const cardArea = ref(null);
        const inputsArea = ref(null);
        const attachBtn = ref(null);

        // Tutorial steps configuration with target info
        const tutorialSteps = [
          {
            icon: '👋',
            title: 'Poďme na to!',
            description: 'Prejdime si základné funkcie aplikácie',
            color: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
            target: null,
            position: 'center'
          },
          {
            icon: '💳',
            title: 'Tvoja peňaženka',
            description: 'Sem patrí tvoj IBAN. Ak máš viac účtov, jednoducho medzi nimi prepínaj potiahnutím do strany.',
            color: 'linear-gradient(135deg, #3b82f6, #06b6d4)',
            target: 'cardArea',
            position: 'bottom'
          },
          {
            icon: '💰',
            title: 'Koľko to bude?',
            description: 'Naťukaj sumu. Je tu aj malá kalkulačka, ak potrebuješ v rýchlosti rozrátať napríklad spoločný obed.',
            color: 'linear-gradient(135deg, #10b981, #14b8a6)',
            target: 'inputsArea',
            position: 'top'
          },
          {
            icon: '📸',
            title: 'Nechce sa ti písať?',
            description: 'Odfoť účtenku cez túto ikonku. Umelá inteligencia sama nájde sumu aj za čo to bolo a pripraví žiadosť za teba.',
            color: 'linear-gradient(135deg, #ec4899, #f43f5e)',
            target: 'attachBtn',
            position: 'top'
          },
          {
            icon: '🚀',
            title: 'Odoslať žiadosť',
            description: 'Klikni na "Vyžiadať" a je to. Výsledok môžeš ukázať na displeji, alebo poslať link cez Messenger, WhatsApp či priamo uloženým kontaktom.',
            color: 'linear-gradient(135deg, #f97316, #f59e0b)',
            target: 'generateBtn',
            position: 'top'
          },
          {
            icon: '📋',
            title: 'Uľahči si to',
            description: 'Robíš rovnakú žiadosť dookola? Ulož si ju sem ako šablónu (napr. Nájom) a nabudúce to máš vybavené na jeden klik.',
            color: 'linear-gradient(135deg, #10b981, #059669)',
            target: 'templatesBtn',
            position: 'bottom'
          },
          {
            icon: '📊',
            title: 'História žiadostí',
            description: 'Tu nájdeš zoznam všetkého, čo si vytvoril. Hneď vidíš, ktoré žiadosti sú už vybavené a ktoré ešte čakajú.',
            color: 'linear-gradient(135deg, #8b5cf6, #d946ef)',
            target: 'historyBtn',
            position: 'bottom'
          },
          {
            icon: '⚙️',
            title: 'Nastavenia',
            description: 'Chceš tmavý režim, inú farbu apky alebo pridať kľúč pre AI skenovanie? Všetky tieto úpravy a správu kontaktov nájdeš tu.',
            color: 'linear-gradient(135deg, #475569, #1e293b)',
            target: 'settingsBtn',
            position: 'bottom'
          }
        ];

        // Computed tooltip position based on current step
        const tooltipPosition = computed(() => {
          const step = tutorialSteps[tutorialStep.value];

          // Center position for welcome/finish screens
          if (step.position === 'center' || !step.target) {
            return {
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)'
            };
          }

          // Get target element reference
          let targetEl = null;
          switch (step.target) {
            case 'cardArea': targetEl = cardArea.value; break;
            case 'inputsArea': targetEl = inputsArea.value; break;
            case 'settingsBtn': targetEl = settingsBtn.value; break;
            case 'templatesBtn': targetEl = templatesBtn.value; break;
            case 'historyBtn': targetEl = historyBtn.value; break;
            case 'attachBtn': targetEl = attachBtn.value; break;
            case 'generateBtn': targetEl = document.querySelector('[key="generate"]')?.parentElement; break;
          }

          if (!targetEl) {
            return { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' };
          }

          const rect = targetEl.getBoundingClientRect();
          const tooltipWidth = 320;
          const tooltipHeight = 200;
          const padding = 16;

          let top, left;

          if (step.position === 'bottom') {
            top = rect.bottom + padding;
            left = Math.max(padding, Math.min(rect.left + rect.width / 2 - tooltipWidth / 2, window.innerWidth - tooltipWidth - padding));
          } else if (step.position === 'top') {
            top = rect.top - tooltipHeight - padding;
            left = Math.max(padding, Math.min(rect.left + rect.width / 2 - tooltipWidth / 2, window.innerWidth - tooltipWidth - padding));
          }

          return {
            top: top + 'px',
            left: left + 'px'
          };
        });

        // Theme mode functions
        const applyTheme = (mode) => {
          let shouldBeDark = false;
          if (mode === 'dark') {
            shouldBeDark = true;
          } else if (mode === 'system') {
            shouldBeDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          isDarkMode.value = shouldBeDark;
          if (shouldBeDark) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        };

        const setThemeMode = async (mode) => {
          themeMode.value = mode;
          await window.dbStorage.setItem('themeMode', mode);
          applyTheme(mode);
        };

        const setAccentColor = async (color) => {
          accentColor.value = color;
          await window.dbStorage.setItem('accentColor', color);
          // Remove all accent classes
          document.documentElement.classList.remove('accent-rose', 'accent-emerald', 'accent-amber', 'accent-sky', 'accent-violet');
          // Add new accent class (indigo is default, no class needed)
          if (color !== 'indigo') {
            document.documentElement.classList.add('accent-' + color);
          }
        };

        // Listen for system theme changes
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', (e) => {
          if (themeMode.value === 'system') {
            applyTheme('system');
          }
        });

        // Filtered templates based on search
        const filteredTemplates = computed(() => {
          if (!templateSearch.value.trim()) return templates.value;
          const search = templateSearch.value.toLowerCase().trim();
          return templates.value.filter(t => {
            const name = (t.name || '').toLowerCase();
            const amount = String(t.amount || '');
            const vs = (t.vs || '').toLowerCase();
            const msg = (t.msg || '').toLowerCase();
            return name.includes(search) ||
              amount.includes(search) ||
              vs.includes(search) ||
              msg.includes(search);
          });
        });

        // Filtered contacts based on search
        const filteredContacts = computed(() => {
          if (!contactSearch.value.trim()) return contacts.value;
          const search = contactSearch.value.toLowerCase().trim();
          return contacts.value.filter(c => {
            const name = (c.name || '').toLowerCase();
            const npub = (c.npub || '').toLowerCase();
            return name.includes(search) || npub.includes(search);
          });
        });

        // Check if a contact is selected
        const isContactSelected = (contact) => {
          return selectedContacts.value.some(c => c.npub === contact.npub);
        };

        // Toggle contact selection (for multi-select / split bill)
        const toggleContactSelection = (contact) => {
          const index = selectedContacts.value.findIndex(c => c.npub === contact.npub);
          if (index >= 0) {
            selectedContacts.value.splice(index, 1);
          } else {
            selectedContacts.value.push({ ...contact });
          }
        };

        // Remove a specific contact from selection
        const removeSelectedContact = (contact) => {
          selectedContacts.value = selectedContacts.value.filter(c => c.npub !== contact.npub);
        };

        // Clear all selected contacts
        const clearSelectedContacts = () => {
          selectedContacts.value = [];
          contactSearch.value = '';
        };

        // Count of unpaid/pending payments for badge
        const unpaidPendingCount = computed(() => {
          return paymentHistory.value.filter(item => {
            if (item.status === 'paid' || item.status === 'incoming') return false;
            return true; // Count both pending and unpaid (past due date)
          }).length;
        });

        // Check if there are incoming requests (for pulsing notification)
        const hasIncomingRequests = computed(() => {
          return paymentHistory.value.some(item => item.status === 'incoming');
        });

        const isAddingTemplate = ref(false);
        const isEditingTemplate = ref(false);
        const editingTemplateIndex = ref(-1);

        // Analytics date range
        const analyticsDateRange = ref('month');
        const customDateFrom = ref('');
        const customDateTo = ref('');
        const activeAnalyticsSlide = ref(0);

        // Slider options for date range
        const dateRangeOptions = ['all', 'today', 'week', 'month', 'year'];
        const dateRangeLabels = {
          all: 'Všetko',
          today: 'Dnes',
          week: 'Tento týždeň',
          month: 'Tento mesiac',
          year: 'Tento rok',
          custom: 'Vlastné obdobie'
        };
        const dateRangeShortLabels = {
          all: 'Vše',
          today: 'Dnes',
          week: 'Týžd.',
          month: 'Mes.',
          year: 'Rok'
        };

        const onAnalyticsScroll = () => {
          if (analyticsCarousel.value) {
            const scrollLeft = analyticsCarousel.value.scrollLeft;
            const width = analyticsCarousel.value.offsetWidth;
            activeAnalyticsSlide.value = Math.round(scrollLeft / width);
          }
        };

        // Custom tags
        const showCustomTagForm = ref(false);
        const customTag = ref({ label: '', color: '#6366f1', emoji: '🏷️' });
        const customTags = ref([]);

        // Amount suggestions
        const showAmountSuggestions = ref(false);
        const recentAmounts = computed(() => {
          const amounts = paymentHistory.value
            .map(h => Number(h.amount))
            .filter(a => a > 0);
          // Get unique amounts, sorted by frequency then value
          const frequency = {};
          amounts.forEach(a => frequency[a] = (frequency[a] || 0) + 1);
          let uniqueAmounts = [...new Set(amounts)]
            .sort((a, b) => frequency[b] - frequency[a]);

          // Filter by current input if user has typed something
          const currentInput = String(payment.value.amount || '').trim();
          if (currentInput) {
            uniqueAmounts = uniqueAmounts.filter(a => {
              const amountStr = a.toFixed(2);
              return amountStr.startsWith(currentInput) || String(a).startsWith(currentInput);
            });
          }

          return uniqueAmounts.slice(0, 5);
        });

        const selectAmount = (amount) => {
          payment.value.amount = amount;
          showAmountSuggestions.value = false;
        };

        const hideAmountSuggestions = () => {
          setTimeout(() => {
            if (!showCalculator.value) {
              showAmountSuggestions.value = false;
            }
          }, 150);
        };

        // Calculator
        const showCalculator = ref(false);
        const calcDisplay = ref('');
        const calcResult = ref(null);

        const toggleCalculator = () => {
          showCalculator.value = !showCalculator.value;
          if (showCalculator.value) {
            showAmountSuggestions.value = false;
            calcDisplay.value = payment.value.amount ? String(payment.value.amount) : '';
            calcResult.value = payment.value.amount ? Number(payment.value.amount) : null;
          }
        };

        const calcInput = (val) => {
          // Prevent multiple operators in a row
          const operators = ['+', '-', '×', '÷'];
          const lastChar = calcDisplay.value.slice(-1);
          if (operators.includes(val) && operators.includes(lastChar)) {
            calcDisplay.value = calcDisplay.value.slice(0, -1) + val;
          } else if (val === '.' && calcDisplay.value.split(/[+\-×÷]/).pop().includes('.')) {
            // Prevent multiple decimals in same number
            return;
          } else {
            calcDisplay.value += val;
          }
          evaluateCalc();
        };

        const calcClear = () => {
          calcDisplay.value = '';
          calcResult.value = null;
        };

        const calcBackspace = () => {
          calcDisplay.value = calcDisplay.value.slice(0, -1);
          evaluateCalc();
        };

        const evaluateCalc = () => {
          try {
            // Replace × and ÷ with * and /
            let expr = calcDisplay.value.replace(/×/g, '*').replace(/÷/g, '/');
            // Remove trailing operator
            expr = expr.replace(/[+\-*/]$/, '');
            if (expr) {
              calcResult.value = Function('"use strict"; return (' + expr + ')')();
              if (!isFinite(calcResult.value)) calcResult.value = null;
            } else {
              calcResult.value = null;
            }
          } catch (e) {
            calcResult.value = null;
          }
        };

        const calcApply = () => {
          if (calcResult.value !== null && isFinite(calcResult.value)) {
            payment.value.amount = Math.round(calcResult.value * 100) / 100;
          }
          showCalculator.value = false;
        };

        // Available emojis for accounts
        const availableEmojis = ['🏠', '🏢', '👨‍💼', '👨‍👩‍👧', '💰', '💳', '🏫', '🏥', '🚗', '✈️', '🌴', '🎮', '🏃', '🎵', '📚', '❤️'];

        // Tag color palette
        const tagColors = [
          'linear-gradient(135deg, #6366f1, #8b5cf6)',
          'linear-gradient(135deg, #3b82f6, #06b6d4)',
          'linear-gradient(135deg, #10b981, #14b8a6)',
          'linear-gradient(135deg, #f97316, #f59e0b)',
          'linear-gradient(135deg, #f43f5e, #ec4899)',
          'linear-gradient(135deg, #8b5cf6, #d946ef)',
          'linear-gradient(135deg, #475569, #1e293b)',
          'linear-gradient(135deg, #ef4444, #f97316)',
          'linear-gradient(135deg, #84cc16, #22c55e)',
          'linear-gradient(135deg, #06b6d4, #0ea5e9)',
        ];

        // Analytics computed
        const analytics = computed(() => {
          const history = paymentHistory.value.filter(h => h.status === 'paid'); // Only count paid payments
          const now = new Date();
          const thisMonth = now.getMonth();
          const thisYear = now.getFullYear();

          const totalCount = history.length;
          const totalAmount = history.reduce((sum, h) => sum + Number(h.amount), 0);

          const thisMonthItems = history.filter(h => {
            const d = new Date(h.timestamp);
            return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
          });
          const thisMonthAmount = thisMonthItems.reduce((sum, h) => sum + Number(h.amount), 0);

          // Top accounts
          const accountCounts = {};
          history.forEach(h => {
            accountCounts[h.accountName] = (accountCounts[h.accountName] || 0) + 1;
          });
          const topAccounts = Object.entries(accountCounts)
            .map(([name, count]) => ({ name, count }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 3);

          return { totalCount, totalAmount, thisMonthAmount, topAccounts };
        });

        // Filtered analytics with date range and tag breakdown
        const filteredAnalytics = computed(() => {
          const now = new Date();
          let filtered = paymentHistory.value; // Start with all payments

          // Apply date filter
          if (analyticsDateRange.value === 'today') {
            const today = now.toDateString();
            filtered = filtered.filter(h => new Date(h.timestamp).toDateString() === today);
          } else if (analyticsDateRange.value === 'week') {
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            filtered = filtered.filter(h => new Date(h.timestamp) >= weekAgo);
          } else if (analyticsDateRange.value === 'month') {
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            filtered = filtered.filter(h => {
              const d = new Date(h.timestamp);
              return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            });
          } else if (analyticsDateRange.value === 'year') {
            const thisYear = now.getFullYear();
            filtered = filtered.filter(h => new Date(h.timestamp).getFullYear() === thisYear);
          } else if (analyticsDateRange.value === 'custom' && customDateFrom.value && customDateTo.value) {
            const from = new Date(customDateFrom.value);
            const to = new Date(customDateTo.value);
            to.setHours(23, 59, 59, 999);
            filtered = filtered.filter(h => {
              const d = new Date(h.timestamp);
              return d >= from && d <= to;
            });
          }

          // Calculate summary stats (count both paid and unpaid/incoming for context)
          const totalCount = filtered.length;
          const totalAmount = filtered.reduce((sum, h) => sum + Number(h.amount), 0);
          
          // 1. Tag Breakdown (Categories)
          const tagStats = {};
          filtered.forEach(h => {
            // EXCLUDE INCOMING FROM TAG BREAKDOWN
            if (h.status === 'incoming') return;

            const tag = h.tag || 'other';
            if (!tagStats[tag]) {
              tagStats[tag] = { tag, amount: 0, count: 0 };
            }
            tagStats[tag].amount += Number(h.amount);
            tagStats[tag].count += 1;
          });
          const tagBreakdown = Object.values(tagStats)
            .map(stat => ({
              ...stat,
              label: getTagLabel(stat.tag),
              color: getTagColor(stat.tag)
            }))
            .sort((a, b) => b.amount - a.amount);

          // 2. Status Breakdown (Paid vs Unpaid)
          // We treat 'incoming' as pending/unpaid generally, but for this chart:
          // Paid = status === 'paid'
          // Unpaid = everything else
          const statusStats = {
            paid: { label: 'Zaplatené', amount: 0, count: 0, colorClass: 'bg-green-500', bgClass: 'bg-green-500' },
            unpaid: { label: 'Nezaplatené', amount: 0, count: 0, colorClass: 'bg-red-500', bgClass: 'bg-red-500' }
          };
          filtered.forEach(h => {
            if (h.status === 'paid') {
              statusStats.paid.amount += Number(h.amount);
              statusStats.paid.count += 1;
            } else {
              statusStats.unpaid.amount += Number(h.amount);
              statusStats.unpaid.count += 1;
            }
          });
          const statusBreakdown = Object.values(statusStats).sort((a, b) => b.amount - a.amount);

          // 3. Direction Breakdown (Incoming vs Outgoing)
          // Incoming = status === 'incoming' (requests from Nostr)
          // Outgoing = everything else (payments I created)
          const directionStats = {
            outgoing: { label: 'Odoslané', amount: 0, count: 0, colorClass: 'bg-indigo-500', bgClass: 'bg-indigo-500' },
            incoming: { label: 'Prijaté', amount: 0, count: 0, colorClass: 'bg-purple-500', bgClass: 'bg-purple-500' }
          };
          filtered.forEach(h => {
            if (h.status === 'incoming') {
              directionStats.incoming.amount += Number(h.amount);
              directionStats.incoming.count += 1;
            } else {
              directionStats.outgoing.amount += Number(h.amount);
              directionStats.outgoing.count += 1;
            }
          });
          const directionBreakdown = Object.values(directionStats).sort((a, b) => b.amount - a.amount);

          return { 
            totalCount, 
            totalAmount, 
            tagBreakdown,
            statusBreakdown,
            directionBreakdown
          };
        });

        // Helper to get today's date in YYYY-MM-DD format
        const getTodayDate = () => {
          const today = new Date();
          return today.toISOString().split('T')[0];
        };

        // Data - Inputs with today's date pre-filled for dueDate
        const payment = ref({ amount: '', vs: '', msg: '', dueDate: getTodayDate() });
        const newProfile = ref({ name: '', recipientName: '', iban: '', tag: 'personal', emoji: '💳' });

        // Default tags with associated colors and emojis
        const defaultTags = [
          { name: 'personal', label: 'Osobné', color: 'linear-gradient(135deg, #6366f1, #8b5cf6)', emoji: '💳' },
          { name: 'business', label: 'Podnikanie', color: 'linear-gradient(135deg, #f97316, #f59e0b)', emoji: '💼' },
          { name: 'savings', label: 'Úspory', color: 'linear-gradient(135deg, #f43f5e, #ec4899)', emoji: '💰' },
        ];

        // All tags = default + custom
        const allTags = computed(() => [...defaultTags, ...customTags.value]);

        const getTagColor = (tagName) => {
          const tag = allTags.value.find(t => t.name === tagName);
          return tag ? tag.color : 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        };

        const getTagLabel = (tagName) => {
          const tag = allTags.value.find(t => t.name === tagName);
          return tag ? tag.label : tagName;
        };

        const getTagEmoji = (tagName) => {
          const tag = allTags.value.find(t => t.name === tagName);
          return tag ? tag.emoji : '📋';
        };

        const selectTag = (tag) => {
          newProfile.value.tag = tag.name;
          newProfile.value.emoji = tag.emoji || '📋';
        };

        const addCustomTag = async () => {
          if (!customTag.value.label) return showToast('Zadajte názov štítku', 'warning');
          const name = 'custom_' + Date.now();
          const emoji = customTag.value.emoji || '🏷️';
          customTags.value.push({ name, label: customTag.value.label, color: customTag.value.color, emoji });
          await window.dbStorage.setItem('custom_tags', JSON.stringify(customTags.value));
          newProfile.value.tag = name;
          newProfile.value.emoji = emoji;
          customTag.value = { label: '', color: '#6366f1', emoji: '🏷️' };
          showCustomTagForm.value = false;
        };

        const getCardColorClass = (tag) => {
          // Return CSS class based on tag - fallback function for compatibility
          return 'bg-gradient-to-br from-indigo-600 to-violet-700';
        };

        // NOSTR INIT AND LOGIC
        const initNostr = async () => {
          if (!window.NostrTools) {
            await new Promise(r => window.addEventListener('nostr-ready', r));
          }
          const tools = window.NostrTools;

          // Check LocalStorage for Key (separate from indexedDB for keys)
          let skHex = localStorage.getItem('nostr_sk');

          if (!skHex) {
            // Generate new if not exists
            skHex = tools.generatePrivateKey();
            localStorage.setItem('nostr_sk', skHex);
          }

          // Derive public key and display
          try {
            myPrivKey.value = tools.nip19.nsecEncode(skHex);
            const pkHex = tools.getPublicKey(skHex);
            myPubKey.value = pkHex;
            myNpub.value = tools.nip19.npubEncode(pkHex);

            // Start relay connection
            startRelays(pkHex);
          } catch (e) {
            console.error("Nostr Init Error", e);
          }
        };

        const loginWithNewKey = async () => {
          const tools = window.NostrTools;
          try {
            if (!inputPrivKey.value.startsWith('nsec')) {
              showToast('Kľúč musí začínať na nsec1...', 'error');
              return;
            }
            const { data: skHex } = tools.nip19.decode(inputPrivKey.value);
            localStorage.setItem('nostr_sk', skHex);
            location.reload();
          } catch (e) {
            showToast('Neplatný kľúč', 'error');
          }
        };

        const startRelays = (pubHex) => {
          const tools = window.NostrTools;
          if (pool.value) {
            try { pool.value.close(RELAYS); } catch (e) { }
          }

          pool.value = new tools.SimplePool();

          // Subscribe to DM events (Kind 4)
          let sub = pool.value.sub(RELAYS, [
            {
              kinds: [4],
              '#p': [pubHex],
              limit: 50
            }
          ]);

          sub.on('event', async (event) => {
            try {
              const skHex = localStorage.getItem('nostr_sk');
              // Decrypt
              const plaintext = await tools.nip04.decrypt(skHex, event.pubkey, event.content);

              // Parse if it looks like JSON
              try {
                const data = JSON.parse(plaintext);
                // Check if it matches our expected format
                if (data.type === 'gimme_request') {
                  addIncomingPaymentToHistory(event, data);
                }
              } catch (jsonErr) {
                // Not a JSON message, ignore
              }
            } catch (err) {
              console.error("Decryption failed", err);
            }
          });

          // Connection status check
          connectedRelays.value = 0;
          RELAYS.forEach(async (url) => {
            try {
              await pool.value.ensureRelay(url);
              connectedRelays.value++;
            } catch (e) { }
          });
        };

        const addIncomingPaymentToHistory = async (event, data) => {
          // Avoid duplicates by checking Event ID
          if (paymentHistory.value.find(h => h.nostrId === event.id)) return;

          const newItem = {
            id: Date.now() + Math.random(), // Internal ID
            nostrId: event.id, // Store Nostr Event ID to share
            timestamp: new Date(event.created_at * 1000).toISOString(),
            accountName: 'Nostr User',
            amount: data.amount,
            paymeUrl: data.url,
            status: 'incoming', // Special status for incoming requests
            msg: data.note || 'Platba cez Nostr'
          };

          paymentHistory.value.push(newItem);
          await window.dbStorage.setItem('payment_history', JSON.stringify(paymentHistory.value));
        };

        const sendNostrPayment = async () => {
          if (selectedContacts.value.length === 0) return showToast('Vyberte príjemcov z adresára', 'warning');
          isSendingNostr.value = true;
          const tools = window.NostrTools;
          const skHex = localStorage.getItem('nostr_sk');
          const url = getPaymeUrl();
          const profile = getActiveProfileData();
          
          let successCount = 0;
          let errorCount = 0;
          const recipientNames = [];

          // Calculate amount per person when splitting between multiple contacts
          const totalContacts = selectedContacts.value.length;
          const shouldSplit = splitBillEnabled.value && totalContacts > 1;
          const amountPerPerson = shouldSplit 
            ? parseFloat((payment.value.amount / totalContacts).toFixed(2)) 
            : payment.value.amount;

          // Send to each selected contact
          for (const contact of selectedContacts.value) {
            try {
              // Decode recipient key
              let targetHex = contact.npub;
              if (contact.npub.startsWith('npub')) {
                targetHex = tools.nip19.decode(contact.npub).data;
              }

              // Create Payload with divided amount
              const payload = JSON.stringify({
                type: "gimme_request",
                amount: amountPerPerson,
                currency: "EUR",
                url: url,
                note: shouldSplit 
                  ? (payment.value.msg || "Gimme Request") + " (rozdelené: " + amountPerPerson + "€ z " + payment.value.amount + "€)"
                  : (payment.value.msg || "Gimme Request")
              });

              const ciphertext = await tools.nip04.encrypt(skHex, targetHex, payload);

              let event = {
                kind: 4,
                pubkey: myPubKey.value,
                created_at: Math.floor(Date.now() / 1000),
                tags: [['p', targetHex]],
                content: ciphertext
              };

              event.id = tools.getEventHash(event);
              event.sig = tools.getSignature(event, skHex);

              await pool.value.publish(RELAYS, event);

              // Add to history as outgoing for each recipient
              const historyItem = {
                id: Date.now() + Math.random(), // Unique ID for each
                nostrId: event.id,
                timestamp: new Date().toISOString(),
                accountName: profile.name,
                recipientName: contact.name || profile.recipientName,
                amount: amountPerPerson,
                vs: payment.value.vs,
                msg: shouldSplit 
                  ? payment.value.msg + ' (Rozdelené: ' + amountPerPerson + '€ z ' + payment.value.amount + '€ pre ' + contact.name + ')'
                  : payment.value.msg + ' (Odoslané cez Nostr pre ' + contact.name + ')',
                status: 'pending'
              };
              paymentHistory.value.push(historyItem);
              
              successCount++;
              recipientNames.push(contact.name);
            } catch (e) {
              console.error('Error sending to ' + contact.name + ':', e);
              errorCount++;
            }
          }

          // Save history once after all sends
          await window.dbStorage.setItem('payment_history', JSON.stringify(paymentHistory.value));

          if (successCount > 0) {
            const message = successCount === 1 
              ? 'Odoslané pre ' + recipientNames[0] + '!' 
              : 'Odoslané pre ' + successCount + ' kontaktov!';
            showToast(message, 'success');
          }
          if (errorCount > 0) {
            showToast('Chyba pri ' + errorCount + ' odoslaní(ach)', 'error');
          }

          showNostrModal.value = false;
          selectedContacts.value = [];
          isSendingNostr.value = false;
        };

        // --- NEW FEATURES FOR ADDRESS BOOK ---

        const saveNewContact = async () => {
          if (!newContactData.value.name) return;
          // Add or Update
          const existingIndex = contacts.value.findIndex(c => c.npub === newContactData.value.npub);
          if (existingIndex >= 0) {
            contacts.value[existingIndex].name = newContactData.value.name;
          } else {
            contacts.value.push({ ...newContactData.value });
          }
          await window.dbStorage.setItem('nostr_contacts', JSON.stringify(contacts.value));
          showAddContactModal.value = false;
          // Clean URL query param
          window.history.replaceState({}, document.title, window.location.pathname);
          showToast('Kontakt uložený!', 'success');
        };

        const deleteContact = async (npub) => {
          if (!confirm("Zmazať kontakt?")) return;
          contacts.value = contacts.value.filter(c => c.npub !== npub);
          await window.dbStorage.setItem('nostr_contacts', JSON.stringify(contacts.value));
        };

        const generateShareLink = () => {
          const url = window.location.origin + window.location.pathname + '?nostr_id=' + myNpub.value;
          copyToClipboard(url);
        };

        // --- END NEW FEATURES ---

        const copyToClipboard = (text) => {
          navigator.clipboard.writeText(text);
          showToast('Skopírované!', 'success');
        };

        const copyNsec = () => {
          if (myPrivKey.value) {
            navigator.clipboard.writeText(myPrivKey.value);
            showToast('NSEC skopírovaný!', 'warning', 4000);
          }
        };

        // INIT
        onMounted(async () => {
          // Initialize IndexedDB
          await window.dbStorage.init();

          // Hide the loading spinner
          const loader = document.getElementById('app-loader');
          if (loader) loader.style.display = 'none';

          // Load theme mode preference
          const storedThemeMode = await window.dbStorage.getItem('themeMode');
          if (storedThemeMode) {
            themeMode.value = storedThemeMode;
          }
          applyTheme(themeMode.value);

          // Load accent color preference
          const storedAccentColor = await window.dbStorage.getItem('accentColor');
          if (storedAccentColor) {
            setAccentColor(storedAccentColor);
          }

          // Load Gemini API Key
          const storedApiKey = await window.dbStorage.getItem('gemini_api_key');
          if (storedApiKey) geminiApiKey.value = storedApiKey;

          const stored = await window.dbStorage.getItem('payment_profiles_v2');
          if (stored) {
            // Parse and Fix legacy profiles that might miss recipientName
            profiles.value = JSON.parse(stored).map(p => ({
              ...p,
              recipientName: p.recipientName || ''
            }));
          }

          // Load payment history
          const storedHistory = await window.dbStorage.getItem('payment_history');
          if (storedHistory) paymentHistory.value = JSON.parse(storedHistory);

          // Load templates
          const storedTemplates = await window.dbStorage.getItem('payment_templates');
          if (storedTemplates) templates.value = JSON.parse(storedTemplates);

          // Load custom tags
          const storedCustomTags = await window.dbStorage.getItem('custom_tags');
          if (storedCustomTags) customTags.value = JSON.parse(storedCustomTags);

          // Load Nostr Contacts
          const storedContacts = await window.dbStorage.getItem('nostr_contacts');
          if (storedContacts) contacts.value = JSON.parse(storedContacts);

          // Check if tutorial has been completed
          const storedTutorialCompleted = await window.dbStorage.getItem('tutorial_completed');
          if (storedTutorialCompleted) {
            tutorialCompleted.value = true;
          } else {
            // Show tutorial for first-time users
            showTutorial.value = true;
          }

          // Set active profile to default if exists, otherwise first profile
          if (profiles.value.length > 0) {
            const defaultProfile = profiles.value.find(p => p.isDefault);
            activeProfileName.value = defaultProfile ? defaultProfile.name : profiles.value[0].name;

            // Scroll to active profile
            nextTick(() => {
              const activeIndex = profiles.value.findIndex(p => p.name === activeProfileName.value);
              if (activeIndex >= 0 && carouselRef.value) {
                const el = carouselRef.value.children[activeIndex];
                if (el) el.scrollIntoView({ behavior: 'auto', inline: 'center' });
              }
            });
          }

          // Auto-generate VS on initial load
          generateVariableSymbol();

          setupCarouselObserver();

          // INIT NOSTR
          await initNostr();

          // Check for Deep Link (nostr_id query param)
          const params = new URLSearchParams(window.location.search);
          const nid = params.get('nostr_id');
          if (nid) {
            newContactData.value.npub = nid;
            showAddContactModal.value = true;
          }
        });

        const closeQr = () => {
          isQrVisible.value = false;
        };

        // --- CAROUSEL & QR ---
        const setupCarouselObserver = () => {
          if (!carouselRef.value) return;
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const name = entry.target.getAttribute('data-profile');
                activeProfileName.value = name || '';
              }
            });
          }, { root: carouselRef.value, threshold: 0.6 });
          Array.from(carouselRef.value.children).forEach(child => observer.observe(child));
        };

        watch(() => profiles.value.length, () => nextTick(setupCarouselObserver));

        watch(geminiApiKey, async (newVal) => {
          await window.dbStorage.setItem('gemini_api_key', newVal);
        });

        const generateVariableSymbol = () => payment.value.vs = String(Date.now()).slice(-10);

        const formatIban = (iban) => {
          const clean = iban.replace(/\s/g, '');
          return clean.replace(/(.{4})/g, '$1 ').trim();
        };

        // Slovak bank codes mapping
        const SLOVAK_BANKS = {
          '0200': 'VÚB',
          '0720': 'NBS',
          '0900': 'Slovenská sporiteľňa',
          '1100': 'Tatra banka',
          '1111': 'UniCredit Bank',
          '3000': 'SZRB',
          '3100': 'Sberbank',
          '5200': 'OTP Banka',
          '5600': 'Prima banka',
          '5900': 'PSS',
          '6500': 'Poštová banka',
          '7300': 'ING Bank',
          '7500': 'ČSOB',
          '7930': 'Wüstenrot',
          '8020': 'Crédit Agricole',
          '8050': 'Commerzbank',
          '8100': 'Komerční banka',
          '8120': 'Privatbanka',
          '8130': 'Citibank',
          '8160': 'EXIMBANKA',
          '8170': 'ČSOB stavebná sporiteľňa',
          '8191': 'CDCP SR',
          '8300': 'HSBC',
          '8320': 'J&T BANKA',
          '8330': 'Fio banka',
          '8350': 'RBS',
          '8360': 'mBank',
          '8370': 'Oberbank',
          '8380': 'AXA Bank',
          '8390': 'AKCENTA',
          '8400': 'Banco Mais',
          '8410': 'ZUNO BANK',
          '8420': 'BKS Bank',
          '8430': 'KDB Bank',
          '8440': 'Cetelem',
          '9950': 'First Data Slovakia',
          '9951': 'BCPB',
          '9952': 'Trust Pay'
        };

        // Get bank name from IBAN (for Slovak IBANs)
        const getBankName = (iban) => {
          if (!iban) return null;
          const clean = iban.replace(/\s/g, '').toUpperCase();
          // Check if it's a Slovak IBAN (starts with SK)
          if (!clean.startsWith('SK') || clean.length < 8) return null;
          // Bank code is positions 5-8 (0-indexed: 4-7)
          const bankCode = clean.substring(4, 8);
          return SLOVAK_BANKS[bankCode] || null;
        };

        // Remove diacritics from text (ýťšľčžáéíóúäô -> ytsslczaeioua)
        const removeDiacritics = (text) => {
          const diacriticsMap = {
            'á': 'a', 'ä': 'a', 'č': 'c', 'ď': 'd', 'é': 'e', 'ě': 'e', 'í': 'i', 'ĺ': 'l', 'ľ': 'l',
            'ň': 'n', 'ó': 'o', 'ô': 'o', 'ŕ': 'r', 'ř': 'r', 'š': 's', 'ť': 't', 'ú': 'u', 'ů': 'u',
            'ý': 'y', 'ž': 'z',
            'Á': 'A', 'Ä': 'A', 'Č': 'C', 'Ď': 'D', 'É': 'E', 'Ě': 'E', 'Í': 'I', 'Ĺ': 'L', 'Ľ': 'L',
            'Ň': 'N', 'Ó': 'O', 'Ô': 'O', 'Ŕ': 'R', 'Ř': 'R', 'Š': 'S', 'Ť': 'T', 'Ú': 'U', 'Ů': 'U',
            'Ý': 'Y', 'Ž': 'Z'
          };
          return text.split('').map(char => diacriticsMap[char] || char).join('');
        };

        // Clean and normalize IBAN (remove spaces, diacritics, convert to uppercase)
        const cleanIban = (iban) => {
          if (!iban) return '';
          // Remove diacritics, spaces, and convert to uppercase
          return removeDiacritics(iban).replace(/\s/g, '').toUpperCase();
        };

        // Validate IBAN format
        const validateIban = (iban) => {
          const cleaned = cleanIban(iban);
          if (!cleaned) return { valid: false, error: 'IBAN je povinný' };
          
          // IBAN must be 15-34 characters
          if (cleaned.length < 15 || cleaned.length > 34) {
            return { valid: false, error: 'IBAN musí mať 15-34 znakov (aktuálne: ' + cleaned.length + ')' };
          }
          
          // IBAN must start with 2 letters (country code)
          if (!/^[A-Z]{2}/.test(cleaned)) {
            return { valid: false, error: 'IBAN musí začínať 2-písmenným kódom krajiny (napr. SK, CZ)' };
          }
          
          // After country code, must have 2 check digits
          if (!/^[A-Z]{2}[0-9]{2}/.test(cleaned)) {
            return { valid: false, error: 'Po kóde krajiny musia nasledovať 2 kontrolné číslice' };
          }
          
          // Rest must be alphanumeric
          if (!/^[A-Z]{2}[0-9]{2}[A-Z0-9]+$/.test(cleaned)) {
            return { valid: false, error: 'IBAN môže obsahovať iba písmená A-Z a číslice 0-9' };
          }
          
          // Validate checksum using MOD 97 algorithm
          // Move first 4 chars to end
          const rearranged = cleaned.slice(4) + cleaned.slice(0, 4);
          // Convert letters to numbers (A=10, B=11, ... Z=35)
          const numericString = rearranged.split('').map(char => {
            const code = char.charCodeAt(0);
            return code >= 65 && code <= 90 ? (code - 55).toString() : char;
          }).join('');
          // Calculate MOD 97
          let remainder = numericString;
          while (remainder.length > 2) {
            const block = remainder.slice(0, 9);
            remainder = (parseInt(block, 10) % 97).toString() + remainder.slice(9);
          }
          if (parseInt(remainder, 10) % 97 !== 1) {
            return { valid: false, error: 'Neplatné kontrolné číslo IBAN' };
          }
          
          return { valid: true, cleaned: cleaned };
        };

        // IBAN validation error message
        const ibanError = ref('');

        // Watch IBAN input to clean it and validate
        watch(() => newProfile.value.iban, (newVal) => {
          if (newVal) {
            // Auto-clean: remove diacritics and convert to uppercase as user types
            const cleaned = cleanIban(newVal);
            if (cleaned !== newVal.replace(/\s/g, '').toUpperCase()) {
              newProfile.value.iban = cleaned;
            }
            // Validate and show error
            const validation = validateIban(cleaned);
            ibanError.value = validation.valid ? '' : validation.error;
          } else {
            ibanError.value = '';
          }
        });

        // Watch all text inputs to remove diacritics automatically
        // Profile name
        watch(() => newProfile.value.name, (newVal) => {
          if (newVal) {
            const cleaned = removeDiacritics(newVal);
            if (cleaned !== newVal) {
              newProfile.value.name = cleaned;
            }
          }
        });

        // Profile recipient name
        watch(() => newProfile.value.recipientName, (newVal) => {
          if (newVal) {
            const cleaned = removeDiacritics(newVal);
            if (cleaned !== newVal) {
              newProfile.value.recipientName = cleaned;
            }
          }
        });

        // Template name
        watch(() => newTemplate.value.name, (newVal) => {
          if (newVal) {
            const cleaned = removeDiacritics(newVal);
            if (cleaned !== newVal) {
              newTemplate.value.name = cleaned;
            }
          }
        });

        // Template message
        watch(() => newTemplate.value.msg, (newVal) => {
          if (newVal) {
            const cleaned = removeDiacritics(newVal);
            if (cleaned !== newVal) {
              newTemplate.value.msg = cleaned;
            }
          }
        });

        // Payment message
        watch(() => payment.value.msg, (newVal) => {
          if (newVal) {
            const cleaned = removeDiacritics(newVal);
            if (cleaned !== newVal) {
              payment.value.msg = cleaned;
            }
          }
        });

        const saveProfile = async () => {
          const { name, recipientName, iban, tag, emoji } = newProfile.value;
          if (!name || !iban) return showToast('Vyplňte názov účtu a IBAN', 'warning');

          // Clean and validate IBAN
          const cleanedIban = cleanIban(iban);
          const validation = validateIban(cleanedIban);
          if (!validation.valid) {
            return showToast(validation.error, 'error');
          }

          // Fallback for recipientName if left empty
          const safeRecipientName = recipientName || '';

          if (isEditingProfile.value) {
            // Update existing profile
            const index = profiles.value.findIndex(p => p.name === name);
            if (index !== -1) {
              profiles.value[index] = { ...profiles.value[index], recipientName: safeRecipientName, iban: cleanedIban, tag, emoji };
            }
          } else {
            // Add new profile
            profiles.value.push({ ...newProfile.value, iban: cleanedIban, recipientName: safeRecipientName });
          }

          await window.dbStorage.setItem('payment_profiles_v2', JSON.stringify(profiles.value));
          isAddingProfile.value = false;
          isEditingProfile.value = false;
          newProfile.value = { name: '', recipientName: '', iban: '', tag: 'personal', emoji: '💰' };

          if (!isEditingProfile.value) {
            nextTick(() => {
              const el = carouselRef.value.children[profiles.value.length - 1];
              if (el) el.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            });
          }
        };

        const editProfile = (profile) => {
          newProfile.value = {
            name: profile.name,
            recipientName: profile.recipientName || '',
            iban: profile.iban,
            tag: profile.tag || 'personal',
            emoji: profile.emoji || '💰'
          };
          isEditingProfile.value = true;
          isAddingProfile.value = false;
        };

        const cancelProfileForm = () => {
          isAddingProfile.value = false;
          isEditingProfile.value = false;
          newProfile.value = { name: '', recipientName: '', iban: '', tag: 'personal', emoji: '💰' };
        };

        const deleteProfile = async (name) => {
          if (!confirm("Zmazať účet?")) return;
          profiles.value = profiles.value.filter(p => p.name !== name);
          await window.dbStorage.setItem('payment_profiles_v2', JSON.stringify(profiles.value));
          activeProfileName.value = profiles.value.length > 0 ? profiles.value[0].name : '';
        };

        const toggleDefaultProfile = async (name) => {
          profiles.value = profiles.value.map(p => ({
            ...p,
            isDefault: p.name === name
          }));
          await window.dbStorage.setItem('payment_profiles_v2', JSON.stringify(profiles.value));
        };

        const getActiveProfileData = () => profiles.value.find(p => p.name === activeProfileName.value);

        const generateQRCode = async () => {
          if (!activeProfileName.value) return showToast('Vyberte alebo vytvorte účet', 'warning');
          if (!payment.value.amount) return showToast('Zadajte sumu', 'warning');

          const profile = getActiveProfileData();

          // Safety check
          if (!profile) return;

          // 1. Prepare Beneficiary Name
          const safeBeneficiaryName = (profile.recipientName || '').trim().substring(0, 70);

          // Log to history
          if (!isQrVisible.value) {
            const historyItem = {
              id: Date.now(),
              timestamp: new Date().toISOString(),
              accountName: profile.name,
              recipientName: safeBeneficiaryName,
              iban: profile.iban,
              amount: payment.value.amount,
              vs: payment.value.vs,
              msg: payment.value.msg,
              dueDate: payment.value.dueDate,
              tag: profile.tag || 'other',
              status: 'pending'
            };
            paymentHistory.value.push(historyItem);
            await window.dbStorage.setItem('payment_history', JSON.stringify(paymentHistory.value));
          }

          isQrVisible.value = true;

          await nextTick();
          if (!qrcodeContainer.value) return;

          qrcodeContainer.value.innerHTML = '';

          try {
            // 2. Generate Gimme Link for QR Code
            const qrData = getPaymeUrl();
            if (!qrData) throw new Error("Could not generate URL");

            new QRCode(qrcodeContainer.value, {
              text: qrData,
              width: 256,
              height: 256,
              colorDark: "#1e293b",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.L
            });
          } catch (e) {
            console.error(e);
            showToast('Chyba pri generovaní QR kódu', 'error');
          }
        };

        const formatDate = (isoString) => {
          const d = new Date(isoString);
          const now = new Date();
          const isToday = d.toDateString() === now.toDateString();
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          const isYesterday = d.toDateString() === yesterday.toDateString();

          const time = d.toLocaleTimeString('sk-SK', { hour: '2-digit', minute: '2-digit' });

          if (isToday) return `Dnes, ${time}`;
          if (isYesterday) return `Včera, ${time}`;
          return d.toLocaleDateString('sk-SK', { day: 'numeric', month: 'short' }) + `, ${time}`;
        };

        const clearHistory = async () => {
          if (!confirm('Vymazať celú históriu platieb?')) return;
          paymentHistory.value = [];
          await window.dbStorage.removeItem('payment_history');
        };

        const exportHistoryCSV = () => {
          if (paymentHistory.value.length === 0) return;

          // CSV headers
          const headers = ['Dátum', 'Čas', 'Účet', 'Príjemca', 'Suma', 'Mena', 'VS', 'Správa', 'Splatnosť', 'Stav'];

          // Convert history items to CSV rows
          const rows = paymentHistory.value.map(item => {
            const date = new Date(item.timestamp);
            const dateStr = date.toLocaleDateString('sk-SK');
            const timeStr = date.toLocaleTimeString('sk-SK', { hour: '2-digit', minute: '2-digit' });
            
            // Determine status label
            let statusLabel = 'Čakajúce';
            if (item.status === 'paid') statusLabel = 'Zaplatené';
            else if (item.status === 'incoming') statusLabel = 'Prijatá žiadosť';
            else if (item.dueDate) {
              const now = new Date();
              now.setHours(0, 0, 0, 0);
              const dueDate = new Date(item.dueDate);
              dueDate.setHours(0, 0, 0, 0);
              if (now > dueDate) statusLabel = 'Po splatnosti';
            }

            // Escape CSV values (wrap in quotes if contains comma, quote, or newline)
            const escapeCSV = (val) => {
              if (val == null) return '';
              const str = String(val);
              if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
              }
              return str;
            };

            return [
              escapeCSV(dateStr),
              escapeCSV(timeStr),
              escapeCSV(item.accountName || ''),
              escapeCSV(item.recipientName || ''),
              escapeCSV(Number(item.amount).toFixed(2)),
              'EUR',
              escapeCSV(item.vs || ''),
              escapeCSV(item.msg || ''),
              escapeCSV(item.dueDate || ''),
              escapeCSV(statusLabel)
            ].join(',');
          });

          // Combine headers and rows
          const csvContent = [headers.join(','), ...rows].join('\n');

          // Create blob and download
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.setAttribute('href', url);
          link.setAttribute('download', 'historia-platieb-' + new Date().toISOString().split('T')[0] + '.csv');
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          showToast('História exportovaná!', 'success');
        };

        const deleteHistoryItem = async (reversedIndex) => {
          const actualIndex = paymentHistory.value.length - 1 - reversedIndex;
          paymentHistory.value.splice(actualIndex, 1);
          await window.dbStorage.setItem('payment_history', JSON.stringify(paymentHistory.value));
        };

        const markAsPaid = async (paymentId) => {
          const payment = paymentHistory.value.find(h => h.id === paymentId);
          if (payment) {
            payment.status = 'paid';
            await window.dbStorage.setItem('payment_history', JSON.stringify(paymentHistory.value));
          }
        };

        const getPaymentStatusStyle = (item) => {
          // If already paid
          if (item.status === 'paid') {
            return {
              borderColor: '#22c55e',
              badgeClass: 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
              label: 'Zaplatené',
              canMarkPaid: false
            };
          }

          // Check if past due date
          const now = new Date();
          now.setHours(0, 0, 0, 0); // Reset to start of day for comparison

          if (item.dueDate) {
            const dueDate = new Date(item.dueDate);
            dueDate.setHours(0, 0, 0, 0);

            if (now > dueDate) {
              // Unpaid (past due date)
              return {
                borderColor: '#ef4444',
                badgeClass: 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300',
                label: 'Nezaplatené',
                canMarkPaid: true
              };
            }
          }

          // Still pending (before due date or no due date set)
          return {
            borderColor: '#f59e0b',
            badgeClass: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300',
            label: 'Čakajúce',
            canMarkPaid: true
          };
        };

        const duplicatePayment = (item) => {
          // Find the profile that matches this payment
          if (item.status !== 'incoming') {
            const profile = profiles.value.find(p => p.name === item.accountName);
            if (profile) {
              activeProfileName.value = profile.name;
              // Scroll to the profile card
              nextTick(() => {
                const activeIndex = profiles.value.findIndex(p => p.name === activeProfileName.value);
                if (activeIndex >= 0 && carouselRef.value) {
                  const el = carouselRef.value.children[activeIndex];
                  if (el) el.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
              });
            }
          }
          // Copy payment details
          payment.value.amount = item.amount;
          payment.value.vs = item.vs || '';
          payment.value.msg = item.msg || '';
          payment.value.dueDate = item.dueDate || '';
          // Generate new VS
          generateVariableSymbol();
          // Close history panel
          showHistory.value = false;
        };

        const getPaymeUrl = () => {
          const profile = getActiveProfileData();
          if (!profile) return '';

          // Construct params in the expected order: V, IBAN, AM, CC, DT, PI, MSG, CN
          const params = new URLSearchParams({
            V: '1',
            IBAN: profile.iban.replace(/\s/g, ''),
            AM: Number(payment.value.amount).toFixed(2),
            CC: 'EUR'
          });

          // Add Due Date (Format: YYYYMMDD)
          if (payment.value.dueDate) {
            const date = payment.value.dueDate.replace(/-/g, '');
            params.append('DT', date);
          }

          // Add Variable Symbol (Payment Identification)
          if (payment.value.vs) {
            params.append('PI', '/VS' + payment.value.vs.trim());
          }

          // Add Message
          if (payment.value.msg) {
            params.append('MSG', payment.value.msg.trim());
          }

          // Add Client Name (Beneficiary)
          if (profile.recipientName) {
            params.append('CN', profile.recipientName.trim());
          }

          return `https://payme.sk?${params.toString()}`;
        };

        const sharePaymeLink = async () => {
          const url = getPaymeUrl();
          const profile = getActiveProfileData();
          const shareData = {
            title: 'Žiadosť o platbu',
            text: `Platba ${Number(payment.value.amount).toFixed(2)}€ pre ${profile?.recipientName || 'príjemcu'}`,
            url: url
          };

          if (navigator.share) {
            try {
              await navigator.share(shareData);
            } catch (e) {
              if (e.name !== 'AbortError') {
                // Fallback to copy if share fails
                await navigator.clipboard.writeText(url);
                paymeLinkCopied.value = true;
                setTimeout(() => paymeLinkCopied.value = false, 2000);
              }
            }
          } else {
            // Fallback for browsers without Web Share API
            await navigator.clipboard.writeText(url);
            paymeLinkCopied.value = true;
            setTimeout(() => paymeLinkCopied.value = false, 2000);
          }
        };

        // Template functions
        const saveTemplate = async () => {
          if (!newTemplate.value.name || !newTemplate.value.amount) {
            return showToast('Vyplňte názov a sumu', 'warning');
          }

          if (isEditingTemplate.value) {
            templates.value[editingTemplateIndex.value] = { ...newTemplate.value };
          } else {
            templates.value.push({ ...newTemplate.value });
          }

          await window.dbStorage.setItem('payment_templates', JSON.stringify(templates.value));
          newTemplate.value = { name: '', amount: '', vs: '', msg: '', dueDate: '' };
          isAddingTemplate.value = false;
          isEditingTemplate.value = false;
          editingTemplateIndex.value = -1;
        };

        const applyTemplate = (template) => {
          payment.value.amount = template.amount;
          if (template.vs) payment.value.vs = template.vs;
          if (template.msg) payment.value.msg = template.msg;
          if (template.dueDate) payment.value.dueDate = template.dueDate;
          showTemplates.value = false;
        };

        const editTemplate = (template, index) => {
          newTemplate.value = { ...template };
          isAddingTemplate.value = false;
          isEditingTemplate.value = true;
          editingTemplateIndex.value = index;
        };

        const cancelTemplateEdit = () => {
          newTemplate.value = { name: '', amount: '', vs: '', msg: '', dueDate: '' };
          isAddingTemplate.value = false;
          isEditingTemplate.value = false;
          editingTemplateIndex.value = -1;
        };

        const deleteTemplate = async (index) => {
          if (!confirm('Vymazať túto šablónu?')) return;
          templates.value.splice(index, 1);
          await window.dbStorage.setItem('payment_templates', JSON.stringify(templates.value));
        };

        const copyPaymeLink = async () => {
          const url = getPaymeUrl(); // Re-use the fixed function
          if (!url) return;
          try {
            await navigator.clipboard.writeText(url);
            paymeLinkCopied.value = true;
            setTimeout(() => paymeLinkCopied.value = false, 2000);
          } catch (e) {
            showToast('Nepodarilo sa skopírovať link', 'error');
          }
        };

        // File attachment / Gemini functionality
        const processImageWithGemini = async (base64Image, mimeType) => {
          if (!geminiApiKey.value) {
            showToast('Zadajte Gemini API Kľúč v nastaveniach', 'warning');
            showSettings.value = true;
            isProcessingFile.value = false;
            return;
          }

          try {
            const prompt = `Analyze this receipt/invoice image. 
                Extract the total amount (numeric value only) and a very short description of what is being paid for in Slovak language max 3 words. 
                Return ONLY a raw JSON object (no markdown formatting) with these keys: 
                { "amount": number, "msg": "string" }.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${geminiApiKey.value}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  parts: [
                    { text: prompt },
                    { inline_data: { mime_type: mimeType, data: base64Image } }
                  ]
                }]
              })
            });

            const data = await response.json();

            if (data.error) throw new Error(data.error.message);

            // Parse response
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
              throw new Error("Invalid response structure from API");
            }

            let textResponse = data.candidates[0].content.parts[0].text;

            // Clean markdown if present (```json ... ```)
            textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();

            const result = JSON.parse(textResponse);

            // Update UI
            if (result.amount) {
              payment.value.amount = result.amount;
              // Also update calculator display if it was used
              if (showCalculator.value) {
                calcDisplay.value = String(result.amount);
                calcResult.value = result.amount;
              }
            }

            if (result.msg) {
              payment.value.msg = result.msg;
            }

          } catch (error) {
            console.error("Gemini Error:", error);
            showToast('Nepodarilo sa analyzovať obrázok', 'error');
          } finally {
            isProcessingFile.value = false;
          }
        };

        const attachFile = () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*'; // Only images for vision model

          input.onchange = async (event) => {
            const file = event.target.files?.[0];
            if (!file) return;

            // Size check (Gemini has limits, keep it sane, e.g., < 4MB for base64 safety)
            if (file.size > 5 * 1024 * 1024) {
              showToast('Obrázok je príliš veľký (max 5MB)', 'warning');
              return;
            }

            isProcessingFile.value = true;
            attachedFile.value = file;

            const reader = new FileReader();
            reader.onload = async (e) => {
              const base64Data = e.target.result.split(',')[1]; // Remove "data:image/jpeg;base64," prefix
              const mimeType = file.type;
              await processImageWithGemini(base64Data, mimeType);
            };
            reader.onerror = () => {
              showToast('Chyba pri čítaní súboru', 'error');
              isProcessingFile.value = false;
            };
            reader.readAsDataURL(file);
          };

          input.click();
        };

        // Tutorial functions
        const nextTutorialStep = async () => {
          if (tutorialStep.value < tutorialSteps.length - 1) {
            tutorialStep.value++;
          } else {
            // Tutorial completed
            showTutorial.value = false;
            tutorialCompleted.value = true;
            await window.dbStorage.setItem('tutorial_completed', 'true');
          }
        };

        const prevTutorialStep = () => {
          if (tutorialStep.value > 0) {
            tutorialStep.value--;
          }
        };

        const skipTutorial = async () => {
          showTutorial.value = false;
          tutorialCompleted.value = true;
          await window.dbStorage.setItem('tutorial_completed', 'true');
        };

        const restartTutorial = () => {
          tutorialStep.value = 0;
          showTutorial.value = true;
          showSettings.value = false;
        };

        watch(payment, () => {
          if (isQrVisible.value) {
            if (window.t) clearTimeout(window.t);
            window.t = setTimeout(generateQRCode, 300);
          }
        }, { deep: true });

        watch(activeProfileName, () => {
          // Auto-generate new VS when switching accounts
          generateVariableSymbol();
        });

        return {
          carouselRef, qrcodeContainer, settingsBtn, templatesBtn, historyBtn, cardArea, inputsArea, attachBtn, analyticsCarousel,
          isDarkMode, showSettings, settingsTab, themeMode, accentColor, accentColors, isAddingProfile, isEditingProfile, isQrVisible, paymeLinkCopied, showHistory, showTemplates, showCustomTagForm, showAmountSuggestions, attachedFile,
          payment, newProfile, profiles, activeProfileName, allTags, paymentHistory, analytics, filteredAnalytics, templates, filteredTemplates, templateSearch, newTemplate, isAddingTemplate, isEditingTemplate, unpaidPendingCount, hasIncomingRequests,
          customTag, customTags, availableEmojis, tagColors, analyticsDateRange, customDateFrom, customDateTo, recentAmounts, ibanError, activeAnalyticsSlide, onAnalyticsScroll, dateRangeOptions, dateRangeLabels, dateRangeShortLabels,
          showCalculator, calcDisplay, calcResult, toggleCalculator, calcInput, calcClear, calcBackspace, calcApply,
          showTutorial, tutorialStep, tutorialSteps, tutorialCompleted, tooltipPosition, nextTutorialStep, prevTutorialStep, skipTutorial, restartTutorial,
          setThemeMode, setAccentColor, saveProfile, deleteProfile, toggleDefaultProfile, editProfile, cancelProfileForm, formatIban, getBankName, getCardColorClass, getTagLabel, getTagEmoji, getTagColor, selectTag, addCustomTag, generateVariableSymbol, generateQRCode, copyPaymeLink, sharePaymeLink,
          closeQr, formatDate, clearHistory, exportHistoryCSV, deleteHistoryItem, markAsPaid, getPaymentStatusStyle, duplicatePayment, selectAmount, hideAmountSuggestions, saveTemplate, applyTemplate, editTemplate, cancelTemplateEdit, deleteTemplate, attachFile,
          // Gemini exports
          geminiApiKey, isProcessingFile,
          // Toast notification
          toast, showToast,
          // Nostr exports
          myNpub, myNsec, showNostrModal, selectedContacts, splitBillEnabled, contactSearch, filteredContacts, isContactSelected, toggleContactSelection, removeSelectedContact, clearSelectedContacts, isSendingNostr, sendNostrPayment, copyToClipboard, copyNsec, showPrivKeyInput, inputPrivKey, loginWithNewKey, connectedRelays,
          // Address Book Exports
          contacts, showAddContactModal, newContactData, saveNewContact, deleteContact, generateShareLink
        };
      }
    }).mount('#app');
  </script>

  <!-- PWA Installation & Service Worker -->
  <script>
    // PWA Installation Banner
    let deferredPrompt;
    let installBanner = null;

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js', {
            scope: '/'
          });
          console.log('SW registered: ', registration);
          
          // Update available
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateBanner();
              }
            });
          });
          
        } catch (registrationError) {
          console.log('SW registration failed: ', registrationError);
        }
      });
    }

    // PWA Install Prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallBanner();
    });

    // Show Install Banner
    function showInstallBanner() {
      if (installBanner) return; // Already showing
      
      installBanner = document.createElement('div');
      installBanner.className = 'fixed top-4 left-4 right-4 z-[100] bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-down';
      installBanner.innerHTML = `
        <svg class="w-6 h-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
        <div class="flex-1 min-w-0">
          <p class="font-bold text-sm">Nainštalovať Gimme</p>
          <p class="text-xs opacity-90">Pridajte si aplikáciu na hlavnú obrazovku</p>
        </div>
        <button onclick="installPWA()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded font-bold text-sm transition-colors">
          Inštalovať
        </button>
        <button onclick="dismissInstallBanner()" class="text-white/80 hover:text-white p-1">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      `;
      
      document.body.appendChild(installBanner);
      
      // Auto-hide after 10 seconds
      setTimeout(() => {
        dismissInstallBanner();
      }, 10000);
    }

<!-- PWA Installation & Service Worker -->
  <script>
    // PWA Installation Banner
    let deferredPrompt;
    let installBanner = null;

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js', {
            scope: '/'
          });
          console.log('SW registered: ', registration);
          
          // Update available
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateBanner();
              }
            });
          });
          
        } catch (registrationError) {
          console.log('SW registration failed: ', registrationError);
        }
      });
    }

    // PWA Install Prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallBanner();
    });

    // Show Install Banner - STYLED LIKE TOAST ALERTS
    function showInstallBanner() {
      if (installBanner) return; // Already showing
      
      installBanner = document.createElement('div');
      
      // Position: Centered at top, exactly like the Vue toasts
      // We use fixed, left-1/2 and -translate-x-1/2 to center it
      installBanner.className = 'fixed top-6 left-1/2 z-[100] w-full max-w-[340px] px-4 pointer-events-none flex justify-center animate-toast-in';
      
      // Inner HTML mimics the Toast structure (Pill shape, shadow-2xl, border)
      installBanner.innerHTML = `
        <div class="pointer-events-auto w-full px-5 py-3 rounded-full shadow-2xl border border-indigo-100 dark:border-slate-700 bg-white dark:bg-slate-800 flex items-center gap-3">
          
          <!-- Icon Circle (Using Accent/Indigo Color) -->
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center">
             <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
          </div>

          <!-- Text Content -->
          <div class="flex-1 min-w-0">
            <p class="text-xs font-bold text-slate-800 dark:text-slate-200">Nainštalovať aplikáciu</p>
            <p class="text-[10px] text-slate-500 dark:text-slate-400 truncate">Pridať Gimme na plochu</p>
          </div>

          <!-- Action Button (Pill shaped) -->
          <button onclick="installPWA()" class="px-4 py-1.5 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold transition-all active:scale-95 shadow-md shadow-indigo-200 dark:shadow-none">
            Pridať
          </button>

          <!-- Dismiss X -->
          <button onclick="dismissInstallBanner()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 p-1">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      `;
      
      document.body.appendChild(installBanner);
      
      // Auto-hide after 15 seconds
      setTimeout(() => {
        dismissInstallBanner();
      }, 15000);
    }

    // Install PWA
    async function installPWA() {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const result = await deferredPrompt.userChoice;
      
      if (result.outcome === 'accepted') {
        console.log('User installed PWA');
      }
      
      deferredPrompt = null;
      dismissInstallBanner();
    }

    // Dismiss Install Banner
    function dismissInstallBanner() {
      if (installBanner) {
        // Add exit animation class before removing
        installBanner.classList.remove('animate-toast-in');
        installBanner.classList.add('animate-toast-out');
        
        setTimeout(() => {
          if (installBanner) {
            installBanner.remove();
            installBanner = null;
          }
        }, 300); // Wait for animation
      }
    }

    // Show Update Banner (Reusing the same style)
    function showUpdateBanner() {
      const updateBanner = document.createElement('div');
      updateBanner.className = 'fixed top-6 left-1/2 z-[100] w-full max-w-[340px] px-4 pointer-events-none flex justify-center animate-toast-in';
      
      updateBanner.innerHTML = `
        <div class="pointer-events-auto w-full px-5 py-3 rounded-full shadow-2xl border border-emerald-100 dark:border-emerald-900/50 bg-white dark:bg-slate-800 flex items-center gap-3">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center">
             <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-xs font-bold text-slate-800 dark:text-slate-200">Aktualizácia</p>
            <p class="text-[10px] text-slate-500 dark:text-slate-400">Nová verzia je dostupná</p>
          </div>
          <button onclick="updatePWA(this.closest('.fixed'))" class="px-4 py-1.5 rounded-full bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold transition-colors shadow-md shadow-emerald-200 dark:shadow-none">
            Obnoviť
          </button>
        </div>
      `;
      
      document.body.appendChild(updateBanner);
    }

    // Update PWA
    function updatePWA(banner) {
      if(banner) banner.remove();
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
      }
      window.location.reload();
    }

    // Handle App Install Success
    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      dismissInstallBanner();
    });

    // Handle URL parameters for shortcuts
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action');
    
    if (action === 'quick-payment') {
      setTimeout(() => {
        const amountInput = document.querySelector('input[placeholder="0.00"]');
        if (amountInput) amountInput.focus();
      }, 500);
    } else if (action === 'scan-receipt') {
      setTimeout(() => {
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) fileInput.click();
      }, 500);
    }

    // Add CSS for toast animations (Exact match to Vue toast animations)
    if (!document.querySelector('#pwa-styles')) {
      const style = document.createElement('style');
      style.id = 'pwa-styles';
      style.textContent = `
        @keyframes toast-in-js {
          0% { 
            opacity: 0; 
            transform: translateX(-50%) translateY(-30px) scale(0.92); 
            filter: blur(4px);
          }
          100% { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0) scale(1); 
            filter: blur(0px);
          }
        }
        @keyframes toast-out-js {
          0% { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0) scale(1); 
          }
          100% { 
            opacity: 0; 
            transform: translateX(-50%) translateY(-20px) scale(0.95); 
          }
        }
        .animate-toast-in {
          animation: toast-in-js 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
          transform: translateX(-50%); /* Ensure centering is maintained during animation */
        }
        .animate-toast-out {
          animation: toast-out-js 0.3s ease-in forwards;
          transform: translateX(-50%);
        }
      `;
      document.head.appendChild(style);
    }
  </script>
</body>

            </html>

